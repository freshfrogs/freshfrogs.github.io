<!doctype html>
<html lang="en" data-theme="noir">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FreshFrogs ‚Äî Wallet, Mint, Sales, Rarity, Staking</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --font-ui:"Inter",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    --font-display:"Space Grotesk",var(--font-ui);
    --bg:#0b0f13; --ink:#e9f2ff; --muted:#90a3b3; --ring:rgba(255,255,255,.08);
    --panel:#0f141a; --panel-2:#121821; --accent:#35d49a; --accent-ink:#051311;
    --radius:10px; --radius-pill:999px; --focus:0 0 0 3px color-mix(in srgb, var(--accent) 26%, transparent);
  }
  /* Pastel only other theme */
  html[data-theme="pastel"]{
    --bg:#f6fbff; --ink:#11202b; --muted:#5d7a8a; --ring:rgba(0,0,0,.1);
    --panel:#ffffff; --panel-2:#eaf5ff; --accent:#8ad1ff; --accent-ink:#08121a;
  }

  *{box-sizing:border-box} html,body{margin:0;padding:0}
  body{background:var(--bg);color:var(--ink);font:16px/1.55 var(--font-ui)}
  img{max-width:100%;display:block;image-rendering:pixelated}
  a{color:inherit;text-decoration:none}
  .container{width:min(1140px,100%);margin:0 auto;padding:0 20px}

  header.site{position:sticky;top:0;z-index:20;background:color-mix(in srgb, var(--panel) 70%, transparent);backdrop-filter:blur(10px);border-bottom:1px solid var(--ring)}
  header .nav{display:flex;gap:18px;align-items:center}
  header .brand{font:900 18px/1 var(--font-display);letter-spacing:-.01em}
  nav a{opacity:.86;font-weight:600} nav a:hover{opacity:1}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.62rem .9rem;border-radius:var(--radius);border:1px solid color-mix(in srgb, var(--ink) 12%, transparent);background:var(--panel);color:var(--ink);font-weight:800;letter-spacing:.02em;transition:background .15s,border-color .15s,transform .05s,color .15s;cursor:pointer;user-select:none}
  .btn:hover{background:color-mix(in srgb, var(--panel-2) 55%, var(--panel));border-color:color-mix(in srgb, var(--ink) 18%, transparent)}
  .btn:active{transform:translateY(1px)}
  .btn:focus-visible{outline:none;box-shadow:var(--focus)}
  .btn-solid{background:var(--accent);color:var(--accent-ink);border-color:color-mix(in srgb, var(--accent) 50%, transparent)}
  .btn-outline{background:transparent;color:var(--ink);border-color:color-mix(in srgb, var(--ink) 18%, transparent)}
  .btn-ghost{background:transparent;color:var(--muted);border-color:color-mix(in srgb, var(--ink) 10%, transparent)}
  .btn-soft{background:color-mix(in srgb, var(--accent) 14%, var(--panel));border-color:color-mix(in srgb, var(--accent) 22%, var(--ring));color:var(--ink)}
  .btn-sm{padding:.48rem .7rem;border-radius:8px;font-weight:700}
  .btn-lg{padding:.85rem 1.1rem;font-size:1.05rem}
  .icon-btn{width:40px;height:40px;border-radius:8px;display:inline-grid;place-items:center;border:1px solid color-mix(in srgb, var(--ink) 12%, transparent);background:var(--panel);color:var(--ink)}

  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .section-title{font-weight:900;letter-spacing:-.01em;font-family:var(--font-display)}
  .stack{display:flex;flex-direction:column;gap:12px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px} @media(max-width:900px){.two-col{grid-template-columns:1fr}}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:.25rem .6rem;border-radius:var(--radius-pill);border:1px solid var(--ring);background:var(--panel)}
  .spacer{flex:1}
  .thumb64{width:64px;height:64px;min-width:64px;min-height:64px;border-radius:8px;object-fit:cover;aspect-ratio:1/1;image-rendering:pixelated}
  .addr{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

  .hero{padding:56px 0 22px;display:grid;gap:24px;grid-template-columns:1.05fr .95fr;align-items:center}
  @media(max-width:960px){.hero{grid-template-columns:1fr}}
  .gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:0}
  .tile{position:relative;aspect-ratio:1/1;overflow:hidden}
  .tile img{width:100%;height:100%;object-fit:contain}

  .facts{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
  @media(max-width:1100px){.facts{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:580px){.facts{grid-template-columns:1fr}}

  .fact,.panel{background:var(--panel);border:1px solid var(--ring);border-radius:var(--radius);padding:14px;box-shadow:0 1px 0 rgba(0,0,0,.3) inset}
  .panel{margin-block:12px}

  .card-list{list-style:none;margin:0;padding:0;display:grid;gap:8px}
  .list-item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:12px 14px;border-radius:8px;border:1px solid var(--ring);background:var(--panel)}
  .price{font-weight:800}

  .tabs{--tab-i:0;position:relative;display:grid;grid-template-columns:1fr 1fr;padding:4px;border-radius:var(--radius-pill);background:var(--panel-2);border:1px solid var(--ring);min-width:220px;isolation:isolate}
  .tab{position:relative;z-index:1;appearance:none;background:transparent;border:0;padding:.5rem 1rem;border-radius:var(--radius-pill);font-weight:800;cursor:pointer;color:var(--muted);transition:color .15s}
  .tab[aria-selected="true"]{color:var(--accent-ink)}
  .tab-indicator{position:absolute;z-index:0;inset:4px;width:calc(50% - 0px);border-radius:var(--radius-pill);background:var(--accent);box-shadow:0 6px 18px color-mix(in srgb, var(--accent) 40%, transparent);transform:translateX(calc(var(--tab-i) * 100%));transition:transform .22s cubic-bezier(.22,.8,.3,1)}

  footer.site{border-top:1px solid var(--ring);padding:26px 0;color:var(--muted);margin-top:26px}

  .theme-dock{position:fixed;right:14px;bottom:14px;z-index:30;display:flex;gap:8px;flex-wrap:wrap;background:color-mix(in srgb, var(--panel) 82%, transparent);border:1px solid var(--ring);border-radius:12px;padding:8px;backdrop-filter:blur(6px)}
  .swatch{width:28px;height:28px;border-radius:8px;border:1px solid var(--ring);cursor:pointer;display:inline-block}
  .swatch[aria-current="true"]{outline:2px solid var(--accent);outline-offset:2px}
  .sw-noir{background:#0f141a}
  .sw-pastel{background:#eaf5ff}
</style>
</head>
<body>
<header class="site">
  <div class="container" style="height:64px;display:flex;align-items:center;justify-content:space-between;">
    <div class="brand">FreshFrogs</div>
    <nav class="nav">
      <a href="#gallery">Collection</a>
      <a href="#trade">Mint & Staking</a>
      <a href="#features">Features</a>
      <a href="#about">About</a>
      <a href="#faq">FAQ</a>
    </nav>
    <div class="row">
      <span id="walletLabel" class="muted" style="display:none;"></span>
      <button id="connectBtn" class="btn btn-solid btn-sm">Connect Wallet</button>
    </div>
  </div>
</header>

<main class="container">
  <section class="hero">
    <div>
      <h1 class="section-title" style="margin:0;font-size:clamp(2rem,4.2vw,3rem);">Nine random frogs. Clean and fast.</h1>
      <p class="muted" style="max-width:62ch">Hero grid renders standard PNGs. Trait-build code is preserved in comments for later.</p>

      <div class="row" style="margin-top:12px;">
        <a class="btn btn-solid btn-lg" href="#trade">üê∏ Mint & Staking</a>
        <a class="btn btn-outline" href="https://freshfrogs.github.io/" target="_blank" rel="noopener">Original Site</a>
      </div>

      <div id="localLoad" class="muted" style="margin-top:8px;display:none;">
        <div><b>Testing locally?</b> Load your rarity JSON:</div>
        <div class="row" style="margin-top:6px">
          <input id="rarityFile" type="file" accept="application/json,.json" />
          <button id="useLocalBtn" class="btn btn-outline btn-sm">Use selected JSON</button>
        </div>
        <div style="font-size:.9rem;margin-top:4px">Pick <code>assets/freshfrogs_rarity_rankings.json</code></div>
      </div>
    </div>

    <div id="gallery"><div class="gallery" id="grid"></div></div>
  </section>

  <section style="padding:8px 0 6px" class="facts" aria-label="Key facts">
    <div class="fact"><b>Supply</b><div class="muted">4,040 tokens</div></div>
    <div class="fact"><b>Chain</b><div class="muted">Ethereum (ERC-721)</div></div>
    <div class="fact"><b>Royalty</b><div class="muted">5% on secondary sales</div></div>
    <div class="fact"><b>Mint Price</b><div class="muted">0.01 ETH</div></div>
  </section>

  <section id="trade" class="two-col" aria-label="Mint and Staking">
    <div class="panel stack" aria-label="Mint">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><h2 class="section-title" style="margin:0">Mint</h2><div class="muted">Choose quantity, preview total, then mint.</div></div>
        <div class="pill">Price <b>0.01Œû</b></div>
      </div>
      <div class="row" style="gap:10px;align-items:center">
        <button id="mintDown" class="icon-btn" aria-label="Decrease">‚àí</button>
        <div id="mintQty" class="qty-box" aria-live="polite">1</div>
        <button id="mintUp" class="icon-btn" aria-label="Increase">+</button>
        <input id="mintSlider" class="range" type="range" min="1" max="20" step="1" value="1" style="flex:1" />
      </div>
      <div class="row" style="gap:6px;flex-wrap:wrap">
        <button class="btn btn-soft btn-sm" data-preset="1">x1</button>
        <button class="btn btn-soft btn-sm" data-preset="3">x3</button>
        <button class="btn btn-soft btn-sm" data-preset="5">x5</button>
        <button class="btn btn-soft btn-sm" data-preset="10">x10</button>
        <button class="btn btn-soft btn-sm" data-preset="20">x20</button>
      </div>
      <div class="row" style="align-items:center">
        <div class="muted">Total</div>
        <b style="margin-left:6px"><span id="mintTotal">0.01</span> ETH</b>
        <div class="pill" id="gasHint" style="margin-left:10px;">‚âà <span id="gasEst">0.000</span> gas ETH</div>
        <div class="spacer"></div>
        <button id="mintBtn" class="btn btn-solid btn-lg">Mint <u>1</u></button>
      </div>
      <div class="progress"><i id="mintBar"></i></div>
      <p id="mintStatus" class="muted">Status: ready (demo)</p>
    </div>

    <div class="panel stack" aria-label="Staking">
      <div class="row" style="justify-content:space-between">
        <div><h2 class="section-title" style="margin:0">My Frogs</h2><div class="muted">Connect your wallet to view owned & staked.</div></div>
        <div class="tabs" role="tablist" id="stakeTabs">
          <span class="tab-indicator" aria-hidden="true"></span>
          <button class="tab" id="tabOwned"  role="tab" aria-selected="true"  aria-controls="chipWrap">Owned</button>
          <button class="tab" id="tabStaked" role="tab" aria-selected="false" aria-controls="chipWrap">Staked</button>
        </div>
      </div>
      <div id="chipWrap" aria-live="polite"></div>
      <div class="row" id="stakeControls" style="gap:8px;">
        <button id="selectAll" class="btn btn-ghost btn-sm">Select All</button>
        <button id="clearSel"  class="btn btn-ghost btn-sm">Clear</button>
        <div class="spacer"></div>
        <button class="btn btn-solid btn-sm" id="refreshOwned">‚Üª Refresh Owned</button>
        <button class="btn btn-outline btn-sm" id="loadStakedBtn">Load Staked</button>
        <!-- load more button(s) will be appended here -->
      </div>
      <p id="stakeStatus" class="muted">No wallet connected.</p>
    </div>
  </section>

  <section id="features" class="panel stack" aria-label="Features">
    <h2 class="section-title" style="margin:0">Features</h2>
    <p class="muted" style="margin-top:0">If opened from desktop, use the ‚ÄúLoad JSON‚Äù button (above) to load rarity from <code>assets/freshfrogs_rarity_rankings.json</code>.</p>

    <div class="two-col">
      <div class="panel stack" aria-label="Recent Sales">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <b>Recent Sales</b><span class="pill"><span class="muted">Live</span></span>
        </div>
        <ul id="recentSales" class="card-list" aria-live="polite"></ul>
        <div class="row" style="gap:8px;">
          <button class="btn btn-outline" id="recentMore">View more</button>
          <button class="btn btn-ghost"   id="recentLess" style="display:none;">Show less</button>
          <div class="spacer"></div>
          <button class="btn btn-outline" id="refreshBtn">Refresh</button>
          <button class="btn btn-soft" id="fetchLiveBtn">Fetch Live</button>
        </div>
      </div>

      <div class="panel stack" aria-label="Rarity Rankings">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <b>Rarity Rankings</b><span class="pill"><span class="muted">Sorted</span></span>
        </div>
        <ul id="rarityList" class="card-list" aria-live="polite"></ul>
        <div class="row" style="gap:8px;">
          <button class="btn btn-outline" id="sortRankBtn">Sort by Rank</button>
          <button class="btn btn-outline" id="sortScoreBtn">Sort by Score</button>
          <div class="spacer"></div>
          <button class="btn btn-outline" id="rarityMore">View more</button>
          <button class="btn btn-ghost"   id="rarityLess" style="display:none;">Show less</button>
        </div>
      </div>
    </div>
  </section>

  <section id="about" class="panel stack">
    <h2 class="section-title" style="margin:0">About FreshFrogs</h2>
    <p class="muted">FreshFrogs is a collection of pixel frogs with on-chain provenance. All secondary sales carry a 5% royalty.</p>
  </section>

  <section id="faq" class="panel stack">
    <h2 class="section-title" style="margin:0">FAQ</h2>
    <details><summary><b>How do I mint?</b></summary><p class="muted">Connect a Web3 wallet and call the contract mint function. This template includes UI only; add your mint logic when ready.</p></details>
    <details><summary><b>Where can I view the collection?</b></summary><p class="muted">OpenSea or the original site‚Äôs gallery.</p></details>
  </section>
</main>

<footer class="site">
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;">
    <div>¬© FreshFrogs 2025</div>
    <div style="display:flex;gap:12px;">
      <a href="https://x.com" target="_blank" rel="noopener">Twitter</a>
      <a href="#" target="_blank" rel="noopener">Discord</a>
      <a href="https://freshfrogs.github.io/" target="_blank" rel="noopener">Docs</a>
    </div>
  </div>
</footer>

<div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Image preview" style="display:none;place-items:center;background:rgba(0,0,0,.75);position:fixed;inset:0;z-index:50">
  <div id="lightboxStage" class="stage" style="position:relative;width:min(90vmin,520px);aspect-ratio:1/1;background:#000;"></div>
</div>

<!-- Theme chooser (Noir + Pastel only) -->
<div class="theme-dock" role="toolbar" aria-label="Theme chooser">
  <button class="swatch sw-noir"   data-theme="noir"   title="Noir"></button>
  <button class="swatch sw-pastel" data-theme="pastel" title="Pastel"></button>
</div>

<!-- If you have your helpers, host them and then UNCOMMENT the next line: -->
<!-- <script src="assets/ethereum-dapp.js"></script> -->

<script>
'use strict';

/* ================= THEME ================= */
(function(){
  const KEY = "ff_theme";
  const root = document.documentElement;
  function applyTheme(t){
    root.setAttribute("data-theme", t);
    document.querySelectorAll('.theme-dock .swatch').forEach(b=>{
      b.setAttribute('aria-current', b.dataset.theme===t ? 'true' : 'false');
    });
    localStorage.setItem(KEY, t);
  }
  applyTheme(localStorage.getItem(KEY) || root.getAttribute('data-theme') || 'noir');
  document.querySelectorAll('.theme-dock .swatch').forEach(btn=>btn.addEventListener('click', ()=> applyTheme(btn.dataset.theme)));
})();

/* ============ JSON (rarity) LOADER ============ */
const JSON_PATH = "assets/freshfrogs_rarity_rankings.json";
let RARITY_LIST = null, RANK_LOOKUP = null;
function showLocalPicker(){ document.getElementById('localLoad').style.display = 'block'; }
async function fetchJSON(path){ const r=await fetch(path,{cache:"no-store"}); if(!r.ok) throw new Error(r.status); const j=await r.json(); if(!Array.isArray(j)) throw new Error("not array"); return j; }
async function loadRarityFromFetch(){ try{ setRarity(await fetchJSON(JSON_PATH)); return true; }catch{ return false; } }
function setRarity(list){ RARITY_LIST=list; RANK_LOOKUP=Object.fromEntries(list.map(it=>[String(it.id), Number(it.ranking ?? it.rank ?? NaN)]).filter(([,v])=>!Number.isNaN(v))); }
function wireLocalPicker(){
  const pick=document.getElementById('rarityFile'), btn=document.getElementById('useLocalBtn');
  btn?.addEventListener('click', ()=>{
    const f=pick?.files?.[0]; if(!f){ alert("Choose assets/freshfrogs_rarity_rankings.json"); return; }
    const rd=new FileReader(); rd.onload=()=>{ try{ const arr=JSON.parse(rd.result); if(!Array.isArray(arr)) throw 0; setRarity(arr); renderSalesPage(0); renderRarityPage(0); setTab('owned'); document.getElementById('localLoad').style.display='none'; }catch{ alert("Invalid rarity JSON"); } }; rd.readAsText(f);
  });
}
function getRankById(id){ return RANK_LOOKUP ? (RANK_LOOKUP[String(id)] ?? null) : null; }

/* ============ SIMPLE IMAGE GRID ============ */
const SOURCE_PATH = "https://freshfrogs.github.io";
const SUPPLY = 4040;
const gridEl = document.getElementById('grid');
const lightbox = document.getElementById('lightbox');
const lightboxStage = document.getElementById('lightboxStage');

function randomIds(n){ const s=new Set(); while(s.size<n) s.add(1+Math.floor(Math.random()*SUPPLY)); return [...s]; }
function renderSimpleGrid(){
  gridEl.innerHTML = '';
  const ids = randomIds(9);
  ids.forEach(id=>{
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.innerHTML = '<img src="'+SOURCE_PATH+'/frog/'+id+'.png" alt="Frog #'+id+'" loading="lazy" decoding="async">';
    tile.addEventListener('click', ()=>{
      lightboxStage.innerHTML='';
      const big=document.createElement('img'); big.src=SOURCE_PATH+'/frog/'+id+'.png'; big.alt='Frog #'+id;
      big.style.width='100%'; big.style.height='100%'; big.style.objectFit='contain'; big.style.imageRendering='pixelated';
      lightboxStage.appendChild(big); lightbox.style.display='grid';
    });
    gridEl.appendChild(tile);
  });
}
lightbox.addEventListener('click',()=>{ lightbox.style.display='none'; });

/* ============ RECENT SALES (live) ============ */
const COLLECTION_ADDRESS = "0xBE4Bef8735107db540De269FF82c7dE9ef68C51b";
const FROG_API_KEY = (window.frog_api || "YOUR_RESERVOIR_API_KEY_HERE");
const options = { method:'GET', headers:{ accept:'*/*', 'x-api-key': FROG_API_KEY } };

async function fetchTokenSales({ contract = COLLECTION_ADDRESS, limit = 50, continuation = "" } = {}){
  const base = "https://api.reservoir.tools/sales/v6";
  const params = new URLSearchParams({ collection: contract, limit: String(limit), sortBy: "time", sortDirection: "desc" });
  if (continuation) params.set("continuation", continuation);
  const res = await fetch(`${base}?${params.toString()}`, options);
  if(!res.ok) throw new Error(`Reservoir ${res.status}`);
  return res.json();
}
function normalizeAddress(sale){
  const cand = sale?.toAddress || sale?.to || sale?.toUser || sale?.toWallet || sale?.to?.address || sale?.to?.wallet || sale?.to?.id || sale?.to?.name || sale?.to?.profile;
  if (!cand) return "‚Äî";
  const hex = String(cand);
  return /^0x[a-fA-F0-9]{40}$/.test(hex) ? (hex.slice(0,6)+"‚Ä¶"+hex.slice(-4)) : (hex.length>16? hex.slice(0,6)+"‚Ä¶"+hex.slice(-2):hex);
}
function normalizeTimestamp(sale){
  let raw = sale?.timestamp ?? sale?.createdAt ?? sale?.updatedAt ?? null;
  if (raw == null) return null;
  if (typeof raw === "number") { const ms = raw < 1e12 ? raw * 1000 : raw; return new Date(ms); }
  const t = Date.parse(raw); return Number.isNaN(t) ? null : new Date(t);
}
function formatAgo(msAgo){ const s=Math.floor(msAgo/1000); if(s<60) return `${s}s`; const m=Math.floor(s/60); if(m<60) return `${m}m`; const h=Math.floor(m/60); if(h<24) return `${h}h`; const d=Math.floor(h/24); return `${d}d`; }
function mapSalesToSimple(reservoirSales){
  return (reservoirSales || []).map((s)=>{
    const tokenId = s?.token?.tokenId ?? s?.tokenId ?? s?.tokenIdFull ?? s?.token?.id;
    const id = tokenId != null ? parseInt(String(tokenId), 10) : null;
    const buyer = normalizeAddress(s);
    const dt = normalizeTimestamp(s);
    const ageMs = dt ? (Date.now() - dt.getTime()) : 0;
    const p = s?.price?.gross ?? s?.price?.amount ?? s?.price ?? {};
    const eth = (p?.decimal ?? p?.amount?.decimal ?? p?.amount ?? null);
    const priceEth = (eth != null) ? Number(eth) : null;
    if (!id) return null;
    return { id, time: ageMs ? formatAgo(ageMs) : "‚Äî", price: (priceEth != null) ? `${priceEth.toFixed(3)} ETH` : "‚Äî", buyer };
  }).filter(Boolean);
}
let recentSalesData = [];
const PAGE_SIZE = 5; let recentPage = 0; let rarityPage = 0; let raritySortBy = 'rank';

function togglePagerBtns(prefix, page, total){
  const more=document.getElementById(`${prefix}More`);
  const less=document.getElementById(`${prefix}Less`);
  const pages=Math.ceil((total||1)/PAGE_SIZE)||1;
  if(more) more.style.display=(page<pages-1)?'':'none';
  if(less) less.style.display=(page>0)?'':'none';
}
function thumb64(src, alt){ return '<img class="thumb64" src="'+src+'" alt="'+alt+'" width="64" height="64" loading="lazy">'; }
function renderSalesPage(page = 0, list = recentSalesData) {
  const ul = document.getElementById('recentSales'); if (!ul) return;
  ul.innerHTML = '';
  const start = page * PAGE_SIZE, end = start + PAGE_SIZE;
  const arr = (list && list.length) ? list : [{id:3250,time:"3m",price:"0.080 ETH",buyer:"0x9a‚Ä¶D1"}];
  arr.slice(start, end).forEach(sale=>{
    const rank = getRankById ? getRankById(sale.id) : null;
    const rankBadge = (rank||rank===0)?`<span class="pill">Rank <b>#${rank}</b></span>`:`<span class="pill"><span class="muted">Rank N/A</span></span>`;
    const li = document.createElement('li'); li.className='list-item';
    li.innerHTML =
      thumb64(SOURCE_PATH+'/frog/'+sale.id+'.png', 'Frog '+sale.id) +
      `<div>
        <div style="display:flex;align-items:center;gap:8px;"><b>Frog #${sale.id}</b> ${rankBadge}</div>
        <div class="muted">${sale.time!=="‚Äî" ? (sale.time+" ago"):"‚Äî"} ‚Ä¢ Buyer ${sale.buyer}</div>
      </div>
      <div class="price">${sale.price}</div>`;
    ul.appendChild(li);
  });
  togglePagerBtns('recent', page, arr.length);
}
document.getElementById('recentMore')?.addEventListener('click',()=>{ const pages=Math.ceil((recentSalesData.length||1)/PAGE_SIZE); if(recentPage<pages-1) recentPage++; renderSalesPage(recentPage); });
document.getElementById('recentLess')?.addEventListener('click',()=>{ if(recentPage>0) recentPage--; renderSalesPage(recentPage); });
document.getElementById('refreshBtn')?.addEventListener('click', ()=> renderSalesPage(recentPage) );

async function getRecentSalesLive(){
  try{
    if(!FROG_API_KEY || FROG_API_KEY === "YOUR_RESERVOIR_API_KEY_HERE") throw new Error("Missing Reservoir API key");
    const first = await fetchTokenSales({ limit: 50 });
    const mapped = mapSalesToSimple(first.sales || []);
    if (mapped.length){ recentSalesData = mapped; recentPage = 0; renderSalesPage(0); return true; }
    return false;
  }catch(err){
    console.warn("Live sales fetch failed; using demo fallback.", err);
    return false;
  }
}

/* ============ RARITY LIST (5 per page) ============ */
function getSortedRarity(){
  if(!RARITY_LIST?.length) return [];
  const a=[...RARITY_LIST];
  if(raritySortBy==='score') a.sort((x,y)=>Number(y.rarity??y.score??0)-Number(x.rarity??x.score??0));
  else a.sort((x,y)=>Number(x.ranking??x.rank??1e9)-Number(y.ranking??y.rank??1e9));
  return a;
}
function renderRarityPage(page=0){
  const ul=document.getElementById('rarityList'); if(!ul) return; ul.innerHTML='';
  const data=getSortedRarity();
  if(!data.length){ ul.innerHTML='<li class="list-item"><div class="muted">No data yet</div></li>'; togglePagerBtns('rarity',0,0); return; }
  const start=page*PAGE_SIZE, end=start+PAGE_SIZE;
  data.slice(start,end).forEach(item=>{
    const id=item.id, rank=item.ranking??item.rank??'?', score=(item.rarity??item.score??'').toString();
    const li=document.createElement('li'); li.className='list-item';
    li.innerHTML = thumb64(SOURCE_PATH+'/frog/'+id+'.png','Frog '+id)+`<div><div><b>Frog #${id}</b></div><div class="muted">${score?`Rarity Score: ${score}`:`Rarity Score: N/A`}</div></div><span class="pill">#${rank}</span>`;
    ul.appendChild(li);
  });
  togglePagerBtns('rarity',page,data.length);
}
document.getElementById('rarityMore')?.addEventListener('click',()=>{ const pages=Math.ceil(getSortedRarity().length/PAGE_SIZE); if(rarityPage<pages-1) rarityPage++; renderRarityPage(rarityPage); });
document.getElementById('rarityLess')?.addEventListener('click',()=>{ if(rarityPage>0) rarityPage--; renderRarityPage(rarityPage); });
document.getElementById('sortRankBtn')?.addEventListener('click', ()=>{ raritySortBy='rank'; rarityPage=0; renderRarityPage(0); });
document.getElementById('sortScoreBtn')?.addEventListener('click', ()=>{ raritySortBy='score'; rarityPage=0; renderRarityPage(0); });

/* ============ WALLET CONNECT + OWNED/STAKED ============ */
let user_address = null;
const COLLECTION = COLLECTION_ADDRESS;

function shorten(addr){ return addr ? (addr.slice(0,6)+'‚Ä¶'+addr.slice(-4)) : ''; }
function setWalletUI(addr){
  const label = document.getElementById('walletLabel');
  const btn = document.getElementById('connectBtn');
  if(addr){ label.textContent = 'Connected: ' + shorten(addr); label.style.display = ''; btn.textContent = 'Disconnect'; }
  else { label.style.display = 'none'; btn.textContent = 'Connect Wallet'; }
}
async function connectWallet(){
  if (location.protocol === 'file:') { alert('Open the site over http(s) to enable wallet connections.'); return; }
  const provider = window.ethereum;
  if(!provider){ alert("No Ethereum provider found. Install/enable MetaMask."); return; }
  try{
    const accounts = await provider.request({ method: 'eth_requestAccounts' });
    user_address = accounts?.[0] || null;
    setWalletUI(user_address);
    const ss = document.getElementById('stakeStatus'); ss.textContent = user_address ? `Fetching owned tokens for ${shorten(user_address)}‚Ä¶` : 'No wallet connected.';
    if(user_address){ heldTokens = []; heldContinuation = ''; await fetch_held_tokens(user_address); setTab('owned'); }
  }catch(e){ console.warn(e); }
}
function disconnectWallet(){ user_address = null; setWalletUI(null); heldTokens=[]; heldContinuation=''; stakedView.items=[]; stakedView.page=0; renderStakeList(currentTab); document.getElementById('stakeStatus').textContent='Disconnected.'; }
document.getElementById('connectBtn')?.addEventListener('click', ()=>{ user_address ? disconnectWallet() : connectWallet(); });
if(window.ethereum){ window.ethereum.on?.('accountsChanged', (accs)=>{ user_address = accs?.[0] || null; setWalletUI(user_address); if(user_address){ heldTokens=[]; heldContinuation=''; fetch_held_tokens(user_address); } else { renderStakeList(currentTab); } }); }

/* OWNED via Reservoir */
let heldTokens = [];
let heldContinuation = '';
async function fetch_held_tokens(wallet, limit, next_string){
  try{
    wallet = wallet || user_address; if(!wallet){ document.getElementById('stakeStatus').textContent='Connect a wallet to load owned tokens.'; return; }
    const lim = limit || 50;
    const cont = next_string || heldContinuation || '';
    const contQS = cont ? '&continuation='+encodeURIComponent(cont) : '';
    const url = 'https://api.reservoir.tools/users/'+wallet+'/tokens/v8?collection='+COLLECTION+'&limit='+lim+contQS;

    const res = await fetch(url, options);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();

    const items = (data.tokens || []).map(t=>{
      const tokenId = t?.token?.tokenId ?? t?.tokenId ?? t?.id;
      const id = tokenId != null ? parseInt(String(tokenId),10) : null;
      const img = t?.token?.image ?? (SOURCE_PATH + '/frog/' + tokenId + '.png');
      return id ? { id, image: img } : null;
    }).filter(Boolean);

    heldTokens = heldTokens.concat(items);
    heldContinuation = data.continuation || '';

    if(currentTab==='owned') renderStakeList('owned');
    const ss=document.getElementById('stakeStatus'); ss.textContent = `Owned: ${heldTokens.length}` + (heldContinuation ? ' ‚Ä¢ more available' : '');
    renderHeldLoadMore(wallet, lim, heldContinuation);
  }catch(err){
    console.warn('fetch_held_tokens failed:', err);
    document.getElementById('stakeStatus').textContent = 'Failed to fetch owned tokens (check API key).';
  }
}
function renderHeldLoadMore(wallet, limit, continuation){
  const anchor = document.getElementById('stakeControls');
  let btn = document.getElementById('heldMoreBtn');
  if(!continuation){ if(btn) btn.remove(); return; }
  if(!btn){
    btn = document.createElement('button');
    btn.id = 'heldMoreBtn';
    btn.className = 'btn btn-outline btn-sm';
    btn.textContent = 'Load more Owned';
    anchor?.appendChild(btn);
  }
  btn.onclick = ()=> fetch_held_tokens(wallet, limit, continuation);
}

/* STAKED integration (without calling your fetch_staked_tokens) */
const stakedView = { items: [], page: 0, pageSize: 5, hasMore: false, loading: false };
function stakingHelpersAvailable(){
  return typeof getStakedTokens === 'function' && typeof stakerAddress === 'function' && typeof stakingValues === 'function';
}
async function loadStakedTokens(wallet){
  if(!user_address && !wallet){ alert('Connect a wallet first.'); return; }
  wallet = wallet || user_address;

  const status = document.getElementById('stakeStatus');
  if(!stakingHelpersAvailable()){
    status.textContent = 'Staking helpers not found. Include assets/ethereum-dapp.js and reload.';
    return;
  }
  if(stakedView.loading) return;
  stakedView.loading = true; status.textContent = 'Loading staked‚Ä¶';

  try{
    const tokens = await getStakedTokens(wallet); // expected: array of { tokenId } or similar
    // Normalize to simple list of ids
    const tokenIds = (tokens || []).map(t => parseInt(String(t?.tokenId ?? t?.id ?? t), 10)).filter(n=>Number.isFinite(n));
    const results = [];
    for (const token_id of tokenIds){
      // parallelizable, but kept serial to avoid RPC rate limits; tweak if needed
      const owner = await stakerAddress(token_id);
      const vals = await stakingValues(token_id); // [time, lvl, nextlvl, rewards, date]
      const staked_rewards = vals?.[3]; const staked_date = vals?.[4];
      results.push({ id: token_id, owner, staked_date, rewards: staked_rewards });
    }
    stakedView.items = results;
    stakedView.page = 0;
    stakedView.hasMore = false; // you can set true if your helpers paginate
    renderStakeList('staked');
    status.textContent = `Staked: ${results.length}`;
  }catch(err){
    console.warn('loadStakedTokens error:', err);
    status.textContent = 'Failed to load staked tokens.';
  }finally{
    stakedView.loading = false;
  }
}
document.getElementById('loadStakedBtn')?.addEventListener('click', ()=> loadStakedTokens() );

/* OWNED/STAKED TABS + RENDER */
let currentTab='owned';
const tabOwned=document.getElementById('tabOwned');
const tabStaked=document.getElementById('tabStaked');
const tabsWrap=document.getElementById('stakeTabs');

function setTab(which){
  currentTab = which;
  const owned=(which==='owned');
  tabOwned?.setAttribute('aria-selected',  owned ? 'true':'false');
  tabStaked?.setAttribute('aria-selected', owned ? 'false':'true');
  tabsWrap?.style.setProperty('--tab-i', owned ? 0 : 1);
  renderStakeList(which);
}
tabOwned?.addEventListener('click',()=>setTab('owned'));
tabStaked?.addEventListener('click',()=>setTab('staked'));

function renderStakeList(mode){
  const wrap = document.getElementById('chipWrap'); if(!wrap) return;
  const list = document.createElement('ul'); list.className = 'card-list';
  wrap.innerHTML = ''; wrap.appendChild(list);

  if(mode==='owned'){
    const data = (user_address && heldTokens.length) ? heldTokens : null;

    if(!user_address){ list.innerHTML = '<li class="list-item"><div class="muted">Connect your wallet to view owned tokens.</div></li>'; return; }
    if(!data){ list.innerHTML = '<li class="list-item"><div class="muted">No tokens loaded yet. Click ‚ÄúRefresh Owned‚Äù.</div></li>'; return; }

    data.forEach(({id, image})=>{
      const rank = getRankById ? getRankById(id) : null;
      const li = document.createElement('li'); li.className='list-item';
      li.innerHTML =
        thumb64(image || (SOURCE_PATH+'/frog/'+id+'.png'), 'Frog '+id) +
        `<div>
          <div style="display:flex;align-items:center;gap:8px;">
            <b>Frog #${id}</b>
            ${(rank||rank===0)?`<span class="pill">Rank <b>#${rank}</b></span>`:`<span class="pill"><span class="muted">Rank N/A</span></span>`}
          </div>
          <div class="muted">Owned by <span class="addr">${shorten(user_address)}</span></div>
        </div>
        <div class="row" style="gap:6px;">
          <button class="btn btn-outline btn-sm" disabled title="Staking UI separate">üîí Stake</button>
        </div>`;
      list.appendChild(li);
    });

    // Owned "Load more" button handled elsewhere

  } else { // staked
    const items = stakedView.items || [];
    if(!user_address){
      list.innerHTML = '<li class="list-item"><div class="muted">Connect your wallet to load staked tokens.</div></li>'; return;
    }
    if(!items.length){
      list.innerHTML = '<li class="list-item"><div class="muted">No staked tokens yet. Click ‚ÄúLoad Staked‚Äù.</div></li>'; return;
    }

    // Paginate staked: 5 per page
    const start = stakedView.page * stakedView.pageSize;
    const end = start + stakedView.pageSize;
    items.slice(start, end).forEach(({id, owner, staked_date, rewards})=>{
      const rank = getRankById ? getRankById(id) : null;
      const li = document.createElement('li'); li.className='list-item';
      li.innerHTML =
        thumb64(SOURCE_PATH+'/frog/'+id+'.png','Frog '+id) +
        `<div>
          <div style="display:flex;align-items:center;gap:8px;">
            <b>Frog #${id}</b>
            ${(rank||rank===0)?`<span class="pill">Rank <b>#${rank}</b></span>`:`<span class="pill"><span class="muted">Rank N/A</span></span>`}
          </div>
          <div class="muted">Owner <span class="addr">${owner ? shorten(owner) : '‚Äî'}</span> ‚Ä¢ Staked ${staked_date ?? '‚Äî'} ‚Ä¢ Rewards ${Math.round(Number(rewards||0))} Flyz</div>
        </div>
        <div class="row" style="gap:6px;">
          <button class="btn btn-outline btn-sm" id="unstake_${id}" ${typeof initiate_withdraw==='function'?'':'disabled title="initiate_withdraw not found"'}>Un-stake</button>
        </div>`;
      list.appendChild(li);

      // Wire unstake if available
      const ub = document.getElementById(`unstake_${id}`);
      if (ub && typeof initiate_withdraw==='function') {
        ub.onclick = ()=> initiate_withdraw(id);
      }
    });

    // Pager buttons for staked
    let moreBtn = document.getElementById('stakedMoreBtn');
    let lessBtn = document.getElementById('stakedLessBtn');
    const controls = document.getElementById('stakeControls');
    const pages = Math.ceil(items.length / stakedView.pageSize);

    if(!lessBtn){ lessBtn = document.createElement('button'); lessBtn.id='stakedLessBtn'; lessBtn.className='btn btn-ghost btn-sm'; lessBtn.textContent='Show less'; controls.appendChild(lessBtn); }
    if(!moreBtn){ moreBtn = document.createElement('button'); moreBtn.id='stakedMoreBtn'; moreBtn.className='btn btn-outline btn-sm'; moreBtn.textContent='View more'; controls.appendChild(moreBtn); }

    lessBtn.style.display = (stakedView.page>0) ? '' : 'none';
    moreBtn.style.display = (stakedView.page < pages-1) ? '' : 'none';

    moreBtn.onclick = ()=>{ if(stakedView.page < pages-1){ stakedView.page++; renderStakeList('staked'); } };
    lessBtn.onclick = ()=>{ if(stakedView.page > 0){ stakedView.page--; renderStakeList('staked'); } };
  }
}

/* Controls */
document.getElementById('selectAll')?.addEventListener('click',()=>{ document.getElementById('stakeStatus').textContent='Selected all visible tokens (demo).'; });
document.getElementById('clearSel')?.addEventListener('click',()=>{ document.getElementById('stakeStatus').textContent='Cleared selection (demo).'; });
document.getElementById('refreshOwned')?.addEventListener('click',()=>{ if(user_address){ heldTokens=[]; heldContinuation=''; fetch_held_tokens(user_address); } else { document.getElementById('stakeStatus').textContent='Connect a wallet first.'; } });

/* ============ MINT (demo) ============ */
const PRICE_ETH=0.01; let mintQty=1;
const mintQtyEl=document.getElementById('mintQty'); const mintTotalEl=document.getElementById('mintTotal'); const mintBtn=document.getElementById('mintBtn'); const mintBar=document.getElementById('mintBar'); const mintSlider=document.getElementById('mintSlider'); const gasEstEl=document.getElementById('gasEst');
function updateMintUI(){ mintQtyEl.textContent=mintQty; mintSlider.value=String(mintQty); mintTotalEl.textContent=(PRICE_ETH*mintQty).toFixed(2); mintBtn.innerHTML=`Mint <u>${mintQty}</u>`; const gas=0.00015+(mintQty-1)*0.00005; gasEstEl.textContent=gas.toFixed(5); }
document.getElementById('mintUp')?.addEventListener('click',()=>{ mintQty=Math.min(20,mintQty+1); updateMintUI(); });
document.getElementById('mintDown')?.addEventListener('click',()=>{ mintQty=Math.max(1,mintQty-1); updateMintUI(); });
mintSlider?.addEventListener('input', e=>{ mintQty=parseInt(e.target.value,10); updateMintUI(); });
document.querySelectorAll('[data-preset]').forEach(b=>b.addEventListener('click',()=>{ mintQty=parseInt(b.dataset.preset,10); updateMintUI(); }));
mintBtn?.addEventListener('click',()=>{ if(!mintBar) return; mintBar.style.width='0%'; requestAnimationFrame(()=>{ setTimeout(()=>{ mintBar.style.width='100%'; }, 30); }); document.getElementById('mintStatus').textContent=`Mint prepared: ${mintQty} @ ${(PRICE_ETH*mintQty).toFixed(2)} ETH (demo)`; });
updateMintUI();

/* ============ BOOT ============ */
(async function init(){
  // rarity
  let rarityOk = false;
  if(location.protocol !== 'file:'){ rarityOk = await loadRarityFromFetch(); }
  if(!rarityOk){ showLocalPicker(); wireLocalPicker(); }

  // sales
  const liveOk = await getRecentSalesLive();
  const liveBtn = document.getElementById('fetchLiveBtn');
  if (liveOk && liveBtn){ liveBtn.textContent = "Live loaded"; liveBtn.disabled = true; liveBtn.classList.add('btn-ghost'); }
  document.getElementById('fetchLiveBtn')?.addEventListener('click', getRecentSalesLive);

  // lists
  renderSalesPage(0);
  renderRarityPage(0);
  setTab('owned');

  // hero grid
  renderSimpleGrid();

  // auto set label if wallet already connected
  if (window.ethereum?.selectedAddress){
    user_address = window.ethereum.selectedAddress; setWalletUI(user_address); fetch_held_tokens(user_address);
  }
})();
</script>
</body>
</html>

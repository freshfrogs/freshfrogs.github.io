<!doctype html>
<html lang="en" data-theme="t1">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fresh Frogs — Rarity Rankings</title>

  <!-- Use the same base styles as collection.html -->
  <link rel="stylesheet" href="assets/css/styles.css" />
</head>
<body>
  <div class="pg-wrap container">
    <div class="center-wrap">

      <!-- HERO (identical structure so topbar.js inserts the same pill row) -->
      <section class="frog-hero">
        <h1 class="frog-title">freshfrogs.github.io</h1>
        <div class="frog-strip">
          <div class="tile"><img src="frog/12.png"  alt="12"></div>
          <div class="tile"><img src="frog/77.png"  alt="77"></div>
          <div class="tile"><img src="frog/404.png" alt="404"></div>
          <div class="tile"><img src="frog/256.png" alt="256"></div>
          <div class="tile"><img src="frog/999.png" alt="999"></div>
          <div class="tile"><img src="frog/1.png"   alt="1"></div>
        </div>
      </section>

      <!-- Rankings (cards look exactly like dashboard cards) -->
      <section class="pg-card centered-card" id="rankings">
        <div class="pg-card-head">
          <h3>Rarity Rankings</h3>
          <div class="pg-muted">Top of the pond, from most to least rare</div>
        </div>

        <!-- Cards will be injected here using the same card builder as the dashboard -->
        <div id="rankList" aria-live="polite">
          <div class="pg-muted">Loading rankings…</div>
        </div>

        <div style="display:flex; justify-content:center; margin:12px 0 2px;">
          <button class="btn" id="btnMore" style="display:none">Load more</button>
        </div>
      </section>

    </div>
  </div>

  <script>
    // Keep whole 64px tiles only (same as collection)
    function layoutFrogStrip(){
      var strip = document.querySelector('.frog-strip'); if(!strip) return;
      var tiles = Array.prototype.slice.call(strip.querySelectorAll('.tile'));
      var styles = window.getComputedStyle(strip);
      var gap = parseFloat(styles.gap || 12) || 12;
      var tileW = 64, innerW = strip.clientWidth;
      var count = Math.max(1, Math.floor((innerW + gap) / (tileW + gap)));
      tiles.forEach(function(t,i){ t.classList.toggle('hide', i >= count); });
    }
    window.addEventListener('resize', layoutFrogStrip);
    document.addEventListener('DOMContentLoaded', layoutFrogStrip);
  </script>

  <!-- Config + ABIs (before adapter) -->
  <script src="assets/js/config.js"></script>
  <script src="assets/js/controller_abi.js"></script>
  <script src="assets/js/collection_abi.js"></script>

  <!-- Helpers + wallet (same stack collection uses) -->
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/wallet.js"></script>

  <!-- Adapter + renderers + the dashboard card builder -->
  <script src="assets/js/staking-adapter.js"></script>
  <script src="assets/js/frog-renderer.js"></script>
  <script src="assets/js/frog-cards.js"></script>

  <!-- The exact same top buttons as collection.html -->
  <script src="assets/js/topbar.js"></script>

  <script>
  (function(){
    'use strict';

    var CFG = window.FF_CFG || {};
    var ROOT = String(CFG.SOURCE_PATH || '').replace(/\/+$/,'') || '';
    var RANKS_URL = 'assets/freshfrogs_rarity_rankings.json';
    var PAGE = 24;

    var allRanks = [];
    var cursor = 0;
    var listEl = document.getElementById('rankList');
    var btnMore = document.getElementById('btnMore');

    function getJSON(url){
      return fetch(url, { headers:{accept:'application/json'} }).then(function(r){
        if(!r.ok) throw new Error('HTTP '+r.status);
        return r.json();
      });
    }
    function metaURL(id){ return ROOT + '/frog/json/' + id + '.json'; }

    // Chain reads (read-only)
    function getWeb3(){
      if (window.Web3 && window.ethereum) return new Web3(window.ethereum);
      if (window.Web3 && (CFG.RPC_URL||'')) return new Web3(CFG.RPC_URL);
      return null;
    }
    function nftContract(){
      var w3 = getWeb3(); if(!w3) return null;
      var abi = (window.COLLECTION_ABI || window.collection_abi || []);
      return new w3.eth.Contract(abi, CFG.COLLECTION_ADDRESS);
    }
    function ctrlContract(){
      var w3 = getWeb3(); if(!w3) return null;
      var abi = (window.CONTROLLER_ABI || window.controller_abi || []);
      return new w3.eth.Contract(abi, CFG.CONTROLLER_ADDRESS);
    }
    function short(a){ return a ? (a.slice(0,6)+'…'+a.slice(-4)) : '—'; }

    async function ownerOf(id){
      try{ var nft = nftContract(); if(!nft) return null;
        return await nft.methods.ownerOf(String(id)).call();
      }catch(_){ return null; }
    }
    async function tryStakeInfo(tokenId){
      var ctrl = ctrlContract(); if(!ctrl) return null;
      try{
        var i = await ctrl.methods.getStakeInfo(String(tokenId)).call();
        if (i){
          var who = i.owner || i.staker || i.user || i[0] || null;
          var ts  = i.since || i.stakedAt || i.timestamp || i[1] || null;
          return { owner: who||null, sinceMs: ts? (Number(ts)>1e12?Number(ts):Number(ts)*1000) : null };
        }
      }catch(_){}
      try{
        var s = await ctrl.methods.stakerOf(String(tokenId)).call();
        if (s) return { owner:s, sinceMs:null };
      }catch(_){}
      try{
        var t = await ctrl.methods.stakes(String(tokenId)).call();
        if (t){
          var o = t.owner || t.staker || t.user || t[0] || null;
          var ts = t.since || t.stakedAt || t.timestamp || t[1] || null;
          return { owner:o||null, sinceMs: ts? (Number(ts)>1e12?Number(ts):Number(ts)*1000) : null };
        }
      }catch(_){}
      return null;
    }

    function fmtAgo(ms){
      if(!ms||!isFinite(ms))return null;
      var s=Math.max(0,Math.floor((Date.now()-ms)/1000));
      var d=Math.floor(s/86400); if(d>=1) return d+'d ago';
      var h=Math.floor((s%86400)/3600); if(h>=1) return h+'h ago';
      var m=Math.floor((s%3600)/60); if(m>=1) return m+'m ago';
      return s+'s ago';
    }
    function metaLineFor(it){
      if (it.staked){
        var ago = it.sinceMs ? fmtAgo(it.sinceMs) : null;
        var who = it.owner ? short(it.owner) : 'unknown';
        return (ago ? ('Staked '+ago) : 'Staked') + ' • by ' + who;
      }
      return 'Owned by ' + (it.owner ? short(it.owner) : 'unknown');
    }

    function sortRanks(arr){
      return arr.slice().sort(function(a,b){
        return a.ranking - b.ranking || a.id - b.id;
      });
    }

    async function enrichOne(id){
      // metadata for attributes + layered render
      var meta=null, attrs=[];
      try{
        meta = await getJSON(metaURL(id));
        attrs = Array.isArray(meta?.attributes)
          ? meta.attributes.map(function(a){ return { key:(a.key||a.trait_type||''), value:(a.value ?? a.trait_value ?? '') }; })
          : [];
      }catch(_){}

      // on-chain owner / staker
      var currentOwner = await ownerOf(id);
      var isStaked = currentOwner && CFG.CONTROLLER_ADDRESS && (currentOwner.toLowerCase() === CFG.CONTROLLER_ADDRESS.toLowerCase());
      var staker = null, sinceMs = null;
      if (isStaked){
        var info = await tryStakeInfo(id).catch(()=>null);
        if (info){ staker = info.owner || null; sinceMs = info.sinceMs || null; }
      }

      return {
        id: id,
        attrs: attrs,
        metaRaw: meta || null,
        rank: null,
        staked: !!isStaked,
        sinceMs: sinceMs,
        owner: isStaked ? (staker || null) : (currentOwner || null)
      };
    }

    async function renderNext(){
      var remain = allRanks.length - cursor;
      if (remain <= 0){ btnMore.style.display='none'; return; }

      var take = Math.min(PAGE, remain);
      var slice = allRanks.slice(cursor, cursor + take);
      cursor += take;

      var rows = [];
      for (let i=0;i<slice.length;i++){
        var id = slice[i].id;
        var row = await enrichOne(id);
        row.rank = slice[i].ranking;
        rows.push(row);
      }

      var temp = document.createElement('div');
      // Use the SAME card builder as the dashboard; actions off
      FF.renderFrogCards(temp, rows, {
        showActions: false,
        linkOriginal: true,
        linkEtherscan: true,
        metaLine: metaLineFor
      });

      if (listEl.firstElementChild && listEl.firstElementChild.classList.contains('pg-muted')){
        listEl.innerHTML = '';
      }
      while (temp.firstChild){ listEl.appendChild(temp.firstChild); }

      btnMore.style.display = (cursor < allRanks.length) ? '' : 'none';
    }

    async function init(){
      try{
        var ranks = await getJSON(RANKS_URL);
        if (!Array.isArray(ranks) || !ranks.length){
          listEl.innerHTML = '<div class="pg-muted">No rankings available.</div>';
          return;
        }
        allRanks = sortRanks(ranks);
        await renderNext();
      }catch(e){
        console.warn('Ranks load failed', e);
        listEl.innerHTML = '<div class="pg-muted">Failed to load rarity rankings.</div>';
      }
    }

    // Wire "Load more"
    btnMore && btnMore.addEventListener('click', function(){
      btnMore.disabled = true;
      renderNext().finally(function(){ btnMore.disabled = false; });
    });

    // Init
    (document.readyState === 'loading')
      ? document.addEventListener('DOMContentLoaded', init)
      : init();

  })();
  </script>
</body>
</html>

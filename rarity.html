<!doctype html>
<html lang="en" data-theme="t1">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fresh Frogs — Rarity Rankings</title>

  <link rel="stylesheet" href="assets/css/styles.css" />

  <style>
    /* Base (match site look) */
    .pg-wrap{ padding:20px; }
    img{ image-rendering: pixelated; image-rendering: crisp-edges; }

    .pg-card{ padding:14px; border:1px solid var(--border); border-radius:12px; background:var(--panel); }
    .pg-card-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .pg-card-head h3{ margin:0; font-weight:800; font-size:16px; }
    .pg-muted{ color:var(--muted); font-size:13px; }

    /* Centered single-panel layout (fixed width) */
    :root{ --panel-width: 960px; }
    .center-wrap{ display:grid; gap:16px; justify-items:center; }
    .centered-card{ width: min(var(--panel-width), 100%); }

    /* Hero (same as collection.html) */
    .frog-hero{ margin:28px auto 38px; width: min(var(--panel-width), 100%); }
    .frog-title{ margin:0 0 6px 0; font:900 28px/1.15 'Space Grotesk', var(--font-ui); letter-spacing:-.01em; text-align:center; }
    .frog-strip{ display:flex; gap:12px; align-items:center; justify-content:center; overflow:hidden; padding:0; }
    .frog-strip .tile{ flex:0 0 auto; width:64px; height:64px; border-radius:10px; }
    .frog-strip .tile.hide{ display:none !important; }
    .frog-strip img{ width:64px; height:64px; object-fit:contain; }
    @media (max-width:520px){ .frog-hero{ margin:22px auto 30px; } .frog-strip{ gap:10px; } }

    /* Rankings list */
    #rankList{ width:100%; }

    /* Load more row */
    .load-row{ display:flex; justify-content:center; margin:12px 0 2px; }
    .load-row .btn{ font-family:var(--font-ui); border:1px solid var(--border); background:transparent; color:inherit; border-radius:8px; padding:8px 12px; font-weight:700; font-size:12px; }
    #ffTopRow{
      display:flex; justify-content:center; align-items:center;
      gap:10px; padding:10px 0; flex-wrap:nowrap; overflow-x:auto;
      scrollbar-width:none; -webkit-overflow-scrolling:touch; margin-bottom:14px;
    }
    #ffTopRow::-webkit-scrollbar{ display:none; }

    #ffTopRow .btn.btn-connected{ white-space:nowrap; }

    /* Same role colors as your working collection pills */
    #ffTopRow .ffc-connect { background:#144c2b !important; border-color:#2ec56a !important; color:#eaffef !important; }
    #ffTopRow .ffc-pond    { background:#0f3c25 !important; border-color:#20a35d !important; color:#e6f9ee !important; }
    #ffTopRow .ffc-opensea { background:#0e2a44 !important; border-color:#58afff !important; color:#eaf4ff !important; }
    #ffTopRow .ffc-ethers  { background:#22262d !important; border-color:#9aa0aa !important; color:#edf0f5 !important; }
    #ffTopRow .ffc-mutate  { background:#3b1a11 !important; border-color:#ff7a4f !important; color:#ffefe9 !important; }
    #ffTopRow .ffc-rank    { background:#3a2a0f !important; border-color:#ffc262 !important; color:#fff7e6 !important; }

    #ffTopRow .btn.btn-connected:hover{ filter:brightness(1.05); }
    #ffTopRow .ff-sep{ padding:0 2px; color:var(--muted,#9aa0aa); opacity:.7; user-select:none; }

    @media (max-width:720px){
      #ffTopRow{ gap:8px; padding:8px 0; margin-bottom:12px; }
    }
  </style>
</head>
<body>
  <div class="pg-wrap container">
    <div class="center-wrap">

      <!-- HERO (same structure as collection.html so topbar.js can inject the same pill buttons) -->
      <section class="frog-hero">
        <h1 class="frog-title">freshfrogs.github.io</h1>
        <div class="frog-strip">
          <div class="tile"><img src="frog/12.png"  alt="12"></div>
          <div class="tile"><img src="frog/77.png"  alt="77"></div>
          <div class="tile"><img src="frog/404.png" alt="404"></div>
          <div class="tile"><img src="frog/256.png" alt="256"></div>
          <div class="tile"><img src="frog/999.png" alt="999"></div>
          <div class="tile"><img src="frog/1.png"   alt="1"></div>
        </div>
      </section>
      <div id="ffTopRow">
        <button class="btn btn-connected ffc-connect" data-act="connect">Connect Wallet</button>
        <span class="ff-sep">•</span>
        <a class="btn btn-connected ffc-opensea" href="#" target="_blank" rel="noopener">Shop on OpenSea</a>
        <span class="ff-sep">•</span>
        <a class="btn btn-connected ffc-ethers" href="#" target="_blank" rel="noopener">Etherscan</a>
        <span class="ff-sep">•</span>
        <button class="btn btn-connected ffc-rank" data-act="rankings">Rankings</button>
        <span class="ff-sep">•</span>
        <button class="btn btn-connected ffc-pond" data-act="pond">The Pond</button>
        <span class="ff-sep">•</span>
        <button class="btn btn-connected ffc-mutate" data-act="mutate">Mutate</button>
      </div>

      <!-- Rankings -->
      <section class="pg-card centered-card" id="rankings">
        <div class="pg-card-head">
          <h3>Rarity Rankings</h3>
          <div class="pg-muted">Top of the pond, from most to least rare</div>
        </div>

        <div id="rankList" aria-live="polite">
          <div class="pg-muted">Loading rankings…</div>
        </div>

        <div class="load-row" id="loadRow" style="display:none">
          <button class="btn" id="btnMore">Load more</button>
        </div>
      </section>
    </div>
  </div>

  <script>
    /* Keep whole 64px tiles only (hero strip) */
    function layoutFrogStrip(){
      var strip = document.querySelector('.frog-strip'); if(!strip) return;
      var tiles = Array.prototype.slice.call(strip.querySelectorAll('.tile'));
      var styles = window.getComputedStyle(strip);
      var gap = parseFloat(styles.gap || 12) || 12;
      var tileW = 64, innerW = strip.clientWidth;
      var count = Math.max(1, Math.floor((innerW + gap) / (tileW + gap)));
      tiles.forEach(function(t,i){ t.classList.toggle('hide', i >= count); });
    }
    window.addEventListener('resize', layoutFrogStrip);
    document.addEventListener('DOMContentLoaded', layoutFrogStrip);
  </script>

  <!-- Config + ABIs (must be before adapter) -->
  <script src="assets/js/config.js"></script>
  <script src="assets/js/controller_abi.js"></script>
  <script src="assets/js/collection_abi.js"></script>

  <!-- Helpers + wallet -->
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/wallet.js"></script>

  <!-- On-chain adapter + renderers + cards -->
  <script src="assets/js/staking-adapter.js"></script>
  <script src="assets/js/frog-renderer.js"></script>
  <script src="assets/js/frog-cards.js"></script>

  <!-- Top navigation row (same buttons as collection.html) -->
  <script src="assets/js/topbar.js"></script>

  <script>
  (function(){
    'use strict';

    var CFG = window.FF_CFG || {};
    var ROOT = String(CFG.SOURCE_PATH || '').replace(/\/+$/,'') || '';
    var RANKS_URL = 'assets/freshfrogs_rarity_rankings.json'; // [{id, ranking, score}, ...]
    var PAGE = 24;

    var allRanks = [];
    var cursor = 0;
    var listEl = document.getElementById('rankList');
    var btnMore = document.getElementById('btnMore');
    var loadRow = document.getElementById('loadRow');

    function getJSON(url){
      return fetch(url, { headers:{accept:'application/json'} }).then(function(r){
        if(!r.ok) throw new Error('HTTP '+r.status);
        return r.json();
      });
    }
    function metaURL(id){ return ROOT + '/frog/json/' + id + '.json'; }

    // --- chain access (read-only) ---
    function getWeb3(){
      if (window.Web3 && window.ethereum) return new Web3(window.ethereum);
      // read-only fallback via injected provider-less (won't work without provider)
      if (window.Web3 && (CFG.RPC_URL||'')) return new Web3(CFG.RPC_URL);
      return null;
    }
    function nftContract(){
      var w3 = getWeb3(); if(!w3) return null;
      var abi = (window.COLLECTION_ABI || window.collection_abi || []);
      return new w3.eth.Contract(abi, CFG.COLLECTION_ADDRESS);
    }
    function ctrlContract(){
      var w3 = getWeb3(); if(!w3) return null;
      var abi = (window.CONTROLLER_ABI || window.controller_abi || []);
      return new w3.eth.Contract(abi, CFG.CONTROLLER_ADDRESS);
    }

    function short(a){ return a ? (a.slice(0,6)+'…'+a.slice(-4)) : '—'; }

    async function ownerOf(id){
      try{
        var nft = nftContract(); if(!nft) return null;
        return await nft.methods.ownerOf(String(id)).call();
      }catch(_){ return null; }
    }

    async function tryStakeInfo(tokenId){
      var ctrl = ctrlContract(); if(!ctrl) return null;
      // Try a few common shapes
      // 1) getStakeInfo(tokenId) -> {owner, since} or tuple
      try{
        var i = await ctrl.methods.getStakeInfo(String(tokenId)).call();
        var out = {};
        if (i){
          // tuple or object
          out.owner = i.owner || i.staker || i.user || i[0] || null;
          var since = i.since || i.stakedAt || i.timestamp || i[1] || null;
          if (since!=null) out.sinceMs = Number(since)>1e12 ? Number(since) : Number(since)*1000;
        }
        if (out.owner || out.sinceMs) return out;
      }catch(_){}
      // 2) stakerOf(tokenId)
      try{
        var s = await ctrl.methods.stakerOf(String(tokenId)).call();
        if (s) return { owner:s, sinceMs:null };
      }catch(_){}
      // 3) stakes(tokenId) -> tuple
      try{
        var t = await ctrl.methods.stakes(String(tokenId)).call();
        if (t){
          var o = t.owner || t.staker || t.user || t[0] || null;
          var ts = t.since || t.stakedAt || t.timestamp || t[1] || null;
          return { owner:o||null, sinceMs: ts? (Number(ts)>1e12?Number(ts):Number(ts)*1000) : null };
        }
      }catch(_){}
      return null;
    }

    async function enrichOne(id){
      // 1) metadata (for attributes & DOM layering)
      var meta=null, attrs=[];
      try{
        meta = await getJSON(metaURL(id));
        attrs = Array.isArray(meta?.attributes)
          ? meta.attributes.map(function(a){ return { key:(a.key||a.trait_type||''), value:(a.value ?? a.trait_value ?? '') }; })
          : [];
      }catch(_){}

      // 2) determine staking/owner
      var currentOwner = await ownerOf(id);
      var isStaked = currentOwner && CFG.CONTROLLER_ADDRESS && (currentOwner.toLowerCase() === CFG.CONTROLLER_ADDRESS.toLowerCase());
      var staker = null, sinceMs = null;
      if (isStaked){
        try{
          var info = await tryStakeInfo(id);
          if (info){ staker = info.owner || null; sinceMs = info.sinceMs || null; }
        }catch(_){}
      }

      return {
        id: id,
        attrs: attrs,
        metaRaw: meta || null,
        rank: null,          // we set below
        staked: !!isStaked,
        sinceMs: sinceMs,
        owner: isStaked ? (staker || null) : (currentOwner || null)
      };
    }

    function metaLineFor(it){
      if (it.staked){
        var ago = (it.sinceMs && isFinite(it.sinceMs))
          ? (function(ms){ var s=Math.max(0,Math.floor((Date.now()-ms)/1000));
              var d=Math.floor(s/86400); if(d>=1)return d+'d ago';
              var h=Math.floor((s%86400)/3600); if(h>=1)return h+'h ago';
              var m=Math.floor((s%3600)/60); if(m>=1)return m+'m ago';
              return s+'s ago'; })(it.sinceMs)
          : null;
        var who = it.owner ? short(it.owner) : 'unknown';
        return (ago ? ('Staked '+ago) : 'Staked') + ' • by ' + who;
      }
      return 'Owned by ' + (it.owner ? short(it.owner) : 'unknown');
    }

    function sortRanks(arr){
      return arr.slice().sort(function(a,b){
        return a.ranking - b.ranking || a.id - b.id;
      });
    }

    async function renderNext(){
      var remain = allRanks.length - cursor;
      if (remain <= 0){ loadRow.style.display='none'; return; }

      var take = Math.min(PAGE, remain);
      var slice = allRanks.slice(cursor, cursor + take);
      cursor += take;

      // Fetch + enrich each id
      var out = [];
      for (let i=0;i<slice.length;i++){
        var id = slice[i].id;
        var row = await enrichOne(id);
        row.rank = slice[i].ranking;
        out.push(row);
      }

      // Use reusable cards; inject custom meta line (staked/owner)
      var temp = document.createElement('div');
      FF.renderFrogCards(temp, out, {
        showActions: false,
        linkOriginal: true,
        linkEtherscan: true,
        metaLine: metaLineFor
      });

      if (listEl.firstElementChild && listEl.firstElementChild.classList.contains('pg-muted')){
        listEl.innerHTML = '';
      }
      while (temp.firstChild){ listEl.appendChild(temp.firstChild); }

      loadRow.style.display = (cursor < allRanks.length) ? '' : 'none';
    }

    async function init(){
      try{
        var ranks = await getJSON(RANKS_URL);
        if (!Array.isArray(ranks) || !ranks.length){
          listEl.innerHTML = '<div class="pg-muted">No rankings available.</div>';
          return;
        }
        allRanks = sortRanks(ranks);
        loadRow.style.display = '';
        await renderNext();
      }catch(e){
        console.warn('Ranks load failed', e);
        listEl.innerHTML = '<div class="pg-muted">Failed to load rarity rankings.</div>';
      }
    }

    btnMore && btnMore.addEventListener('click', function(){
      btnMore.disabled = true;
      renderNext().finally(function(){ btnMore.disabled = false; });
    });

    (document.readyState === 'loading')
      ? document.addEventListener('DOMContentLoaded', init)
      : init();
  })();
  </script>
</body>
</html>

<!doctype html>
<html lang="en" data-theme="t1">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fresh Frogs — Rarity Rankings</title>

  <link rel="stylesheet" href="assets/css/styles.css" />

  <style>
    /* Base (matches index/collection look) */
    .pg-wrap{ padding:20px; }
    img{ image-rendering: pixelated; image-rendering: crisp-edges; }

    .pg-card{ padding:14px; border:1px solid var(--border); border-radius:12px; background:var(--panel); }
    .pg-card-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .pg-card-head h3{ margin:0; font-weight:800; font-size:16px; }
    .pg-muted{ color:var(--muted); font-size:13px; }

    /* Centered single-panel layout (fixed width) */
    :root{ --panel-width: 960px; }
    .center-wrap{ display:grid; gap:16px; justify-items:center; }
    .centered-card{ width: min(var(--panel-width), 100%); }

    /* Hero (centered) */
    .frog-hero{ margin:28px auto 22px; width: min(var(--panel-width), 100%); }
    .frog-title{ margin:0 0 6px 0; font:900 28px/1.15 'Space Grotesk', var(--font-ui); letter-spacing:-.01em; text-align:center; }
    .frog-strip{ display:flex; gap:12px; align-items:center; justify-content:center; overflow:hidden; padding:0; }
    .frog-strip .tile{ flex:0 0 auto; width:64px; height:64px; border-radius:10px; }
    .frog-strip .tile.hide{ display:none !important; }
    .frog-strip img{ width:64px; height:64px; object-fit:contain; }
    @media (max-width:520px){ .frog-hero{ margin:22px auto 18px; } .frog-strip{ gap:10px; } }

    /* List area (cards injected by FF.renderFrogCards) */
    #rankList{ width:100%; }

    /* Load more row */
    .load-row{ display:flex; justify-content:center; margin:12px 0 2px; }
    .load-row .btn{ font-family:var(--font-ui); border:1px solid var(--border); background:transparent; color:inherit; border-radius:8px; padding:8px 12px; font-weight:700; font-size:12px; }
  </style>
</head>
<body>
  <div class="pg-wrap container">
    <div class="center-wrap">

      <!-- HERO -->
      <section class="frog-hero">
        <h1 class="frog-title">Fresh Frogs — Rarity Rankings</h1>
        <div class="frog-strip">
          <div class="tile"><img src="frog/12.png"  alt="12"></div>
          <div class="tile"><img src="frog/77.png"  alt="77"></div>
          <div class="tile"><img src="frog/404.png" alt="404"></div>
          <div class="tile"><img src="frog/256.png" alt="256"></div>
          <div class="tile"><img src="frog/999.png" alt="999"></div>
          <div class="tile"><img src="frog/1.png"   alt="1"></div>
        </div>
      </section>

      <!-- Rankings -->
      <section class="pg-card centered-card" id="rankings">
        <div class="pg-card-head">
          <h3>Rarity Rankings</h3>
          <div class="pg-muted">Top of the pond, from most to least rare</div>
        </div>
        <div id="rankList" aria-live="polite">
          <div class="pg-muted">Loading rankings…</div>
        </div>
        <div class="load-row" id="loadRow" style="display:none">
          <button class="btn" id="btnMore">Load more</button>
        </div>
      </section>
    </div>
  </div>

  <script>
    /* Keep whole 64px tiles only (hero strip) */
    function layoutFrogStrip(){
      var strip = document.querySelector('.frog-strip'); if(!strip) return;
      var tiles = Array.prototype.slice.call(strip.querySelectorAll('.tile'));
      var styles = window.getComputedStyle(strip);
      var gap = parseFloat(styles.gap || 12) || 12;
      var tileW = 64, innerW = strip.clientWidth;
      var count = Math.max(1, Math.floor((innerW + gap) / (tileW + gap)));
      tiles.forEach(function(t,i){ t.classList.toggle('hide', i >= count); });
    }
    window.addEventListener('resize', layoutFrogStrip);
    document.addEventListener('DOMContentLoaded', layoutFrogStrip);
  </script>

  <!-- Shared libs / config -->
  <script src="assets/js/config.js"></script>
  <script src="assets/js/utils.js"></script>

  <!-- Layered renderer + reusable cards -->
  <script src="assets/js/frog-renderer.js"></script>
  <script src="assets/js/frog-cards.js"></script>

  <!-- Top navigation row -->
  <script src="assets/js/topbar.js"></script>

  <script>
  (function(){
    'use strict';

    var CFG = window.FF_CFG || {};
    var ROOT = String(CFG.SOURCE_PATH || '').replace(/\/+$/,'') || '';
    var RANKS_URL = 'assets/freshfrogs_rarity_rankings.json'; // expects [{id, ranking, score}, ...]
    var PAGE = 24; // cards per load
    var allRanks = []; // [{id, ranking, score}]
    var cursor = 0;
    var listEl = document.getElementById('rankList');
    var btnMore = document.getElementById('btnMore');
    var loadRow = document.getElementById('loadRow');

    function metaURL(id){ return ROOT + '/frog/json/' + id + '.json'; }

    function getJSON(url){
      return fetch(url, { headers:{accept:'application/json'} }).then(function(r){
        if(!r.ok) throw new Error('HTTP '+r.status);
        return r.json();
      });
    }

    async function fetchBatchMeta(ids){
      const out = [];
      for (let i=0;i<ids.length;i++){
        const id = ids[i];
        try{
          const meta = await getJSON(metaURL(id));
          const attrs = Array.isArray(meta?.attributes)
            ? meta.attributes.map(function(a){ return { key:(a.key||a.trait_type||''), value:(a.value ?? a.trait_value ?? '') }; })
            : [];
          out.push({ id:id, attrs:attrs, metaRaw:meta });
        }catch(_){
          out.push({ id:id, attrs:[], metaRaw:null });
        }
      }
      return out;
    }

    function sortRanks(arr){
      // Make sure: lowest ranking number (1) first
      return arr.slice().sort(function(a,b){
        return a.ranking - b.ranking || a.id - b.id;
      });
    }

    async function renderNext(){
      var remain = allRanks.length - cursor;
      if (remain <= 0){ loadRow.style.display='none'; return; }

      var take = Math.min(PAGE, remain);
      var slice = allRanks.slice(cursor, cursor + take);
      cursor += take;

      // fetch metadata for this slice
      var ids = slice.map(function(r){ return r.id; });
      var metas = await fetchBatchMeta(ids);

      // merge rank into items and append
      var rows = metas.map(function(m){
        var rk = slice.find(function(r){ return r.id === m.id; });
        return { id:m.id, attrs:m.attrs, metaRaw:m.metaRaw, rank: rk ? rk.ranking : null, staked:false, sinceMs:null };
      });

      // append to container using reusable cards
      // (no actions, show etherscan + original)
      var temp = document.createElement('div');
      FF.renderFrogCards(temp, rows, {
        showActions: false,
        linkOriginal: true,
        linkEtherscan: true
      });
      if (listEl.firstElementChild && listEl.firstElementChild.classList.contains('pg-muted')){
        listEl.innerHTML = '';
      }
      // move children over
      while (temp.firstChild){ listEl.appendChild(temp.firstChild); }

      // toggle “load more”
      loadRow.style.display = (cursor < allRanks.length) ? '' : 'none';
    }

    async function init(){
      try{
        var ranks = await getJSON(RANKS_URL);
        if (!Array.isArray(ranks) || !ranks.length){
          listEl.innerHTML = '<div class="pg-muted">No rankings available.</div>';
          return;
        }
        allRanks = sortRanks(ranks);
        loadRow.style.display = '';
        await renderNext();
      }catch(e){
        console.warn('Ranks load failed', e);
        listEl.innerHTML = '<div class="pg-muted">Failed to load rarity rankings.</div>';
      }
    }

    btnMore && btnMore.addEventListener('click', function(){
      btnMore.disabled = true;
      renderNext().finally(function(){ btnMore.disabled = false; });
    });

    (document.readyState === 'loading')
      ? document.addEventListener('DOMContentLoaded', init)
      : init();
  })();
  </script>
</body>
</html>

<html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="factoria">
<meta name="twitter:description" content="Decentralized NFT Collection Factory">
<meta name="twitter:image" content="https://rinkeby.factoria.app/_factoria.png">
<meta property="og:url" content="https://rinkeby.factoria.app">
<meta property="og:type" content="website">
<meta property="og:title" content="factoria">
<meta property="og:description" content="Decentralized NFT Collection Factory">
<meta property="og:image" content="https://rinkeby.factoria.app/_factoria.png">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@3.0.0/dist/web3.min.js"></script>
<link href="style.css" rel="stylesheet">
<script src="token_abi.js"></script>
<script src="methods.js"></script>
<script src="hashparser.js"></script>
<script src="page.js"></script>
<script src="fetcher.js"></script>
<script src="cidcleaner.js"></script>
<script src="templates/formItems.js"></script>
<script src="templates/cardItems.js"></script>
<script src="templates/fillerItem.js"></script>
<script src="templates/btnItems.js"></script>
<script>
var web3 = new Web3(window.ethereum)
document.addEventListener("DOMContentLoaded", async () => {
  let token = new Token(token_abi, Params.address, web3)
  await token.init()
  let name = await token.name().call()
  let symbol = await token.symbol().call()
  let config = await token.config().call()
  let permanent = config.permanent
  let html = formItems({
    items: [{
//      key: "placeholder uri", value: config.placeholder, editable: false
//    }, {
//      key: "base uri", value: config.base, editable: false
//    }, {
      key: "permanent", value: permanent, editable: false
    }, {
      key: "total supply", value: config.supply, editable: false
    }]
  })
  document.querySelector(".form-items").innerHTML = html
  document.querySelector("#title").innerHTML = `${name} (${symbol})`
  document.querySelector("#address").innerHTML = Params.address

  // render tokens
  let placeholderURI = "https://ipfs.io/ipfs/bafkreieqcdphcfojcd2vslsxrhzrjqr6cxjlyuekpghzehfexi5c3w55eq"
  if (config.placeholder && config.placeholder.length > 0) {
    placeholderURI = ipfshttp(config.placeholder)
    //placeholderURI = `https://ipfs.io/ipfs/${config.placeholder.replace("ipfs://", "")}`
  }

  // get placeholder image
  //let placeholderURI = `https://gateway.pinata.cloud/ipfs/${config.placeholder}`
  //let placeholderURI = `https://ipfs.io/ipfs/${config.placeholder.replace("ipfs://", "")}`
  let p = await fetch(placeholderURI).then((r) => { return r.json() })

  document.querySelector(".card-items").innerHTML = `<div class='filler'>
<h3><i class="fa-solid fa-angle-up fa-flip"></i> LOADING...</h3>
</div>`
console.log("config", config)

  const page = new Page({
    config: config,
    base: "collection#address=" + Params.address,
    max: async (options) => {
      return parseInt(options.config.supply)
    },
    filter: async (start, end, options) => {
      let items = []
      if (options.config.base) {
        for(let i=start; i<end; i++) {
          let b = config.base.replace("ipfs://", "").slice(0, -1)
          //let metaURI = `https://gateway.pinata.cloud/ipfs/${b}${i}.json`
          let metaURI = `https://ipfs.io/ipfs/${b}/${i}.json`
          try {
            let meta = await fetcher.get(metaURI).then((r) => { return r.json() })
            //let image = "https://ipfs.io/ipfs/" + meta.image.replace("ipfs://", "")
            let image = ipfshttp(meta.image)
            console.log("meta", meta)
            items.push({
              href: `token#address=${Params.address}&tokenId=${i}`,
              address: Params.address,
              tokenId: i,
              image: image,
              placeholder: "question.png",
              name: (meta.name || ""),
              description: (meta.description || ""),
              attributes: (meta.attributes || []),
            })
          } catch (e) {
            console.log("E", e)
            document.querySelector(".card-items").innerHTML = fillerItem({
              title: "IPFS folder doesn't exist",
              message: `The baseURI ${options.config.base} does not exist. Go publish the folder and come back.`,
              link: {
                text: "Go",
                path: "metadata/browse#cid=" + b,
              }
            })
            return;
          }
        }
      } else {
        //let pImage = "https://ipfs.io/ipfs/" + p.image.replace("ipfs://", "")
        let pImage = ipfshttp(p.image)
        for(let i=start; i<end; i++) {
          items.push({
            href: `token#address=${Params.address}&tokenId=${i}`,
            address: Params.address,
            tokenId: i,
            image: pImage,
            placeholder: "question.png",
            name: (p.name || ""),
            description: (p.description || ""),
            attributes: (p.attributes || []),
          })
        }
      }
      return items
    },
    template: cardItems,
    el: ".card-items"
  })
  await page.get(Params.page)
})
</script>
</html>
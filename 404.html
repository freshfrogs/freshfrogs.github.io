<!DOCTYPE html>
<html lang="en">
  <head>
      <title>FreshFrogs Wallet Viewer</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" href="style.css" type="text/css">
      <link rel="shortcut icon" type="image/x-icon" href="https://freshfrogs.github.io/assets/blackWhite.png">

      <!-- Existing scripts you already use -->
      <script src="https://freshfrogs.github.io/assets/rarityrankings.js"></script>
      <script src="https://freshfrogs.github.io/assets/controller_abi.js"></script>
      <script src="https://freshfrogs.github.io/assets/collection_abi.js"></script>
      <script src="https://freshfrogs.github.io/assets/ethereum-dapp.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.0-rc.0/web3.min.js"></script>
      <script src="https://ethereum.factoria.app/f0/token_abi.js"></script>
      <script src="https://unpkg.com/f0js/dist/f0.js"></script>
  </head>
  <body>
    <div class="main_panel">
      <div class="desc_cont">
        <img src="https://freshfrogs.github.io/assets/FLY.gif" class="fly"/>
        <h2>FreshFrogs Wallet Viewer</h2>
        <p class="title_desc">
          Paste a wallet address directly after freshfrogs.github.io/ to view frogs owned and staked by that wallet.
        </p>
        <p class="title_desc">
          Example: freshfrogs.github.io/0x0000000000000000000000000000000000000000
        </p>
        <p class="title_desc">
          Currently viewing: <span id="wallet-address" class="wallet_invalid">No wallet detected</span>
        </p>
        <a class="pointer" href="https://freshfrogs.io/the-pond" target="_blank">Stake your frogs üê∏</a>
        <br>
        <a class="pointer" href="https://freshfrogs.io/" target="_blank">Return to homepage ‚Ü©Ô∏è</a>
      </div>
    </div>

    <div class="wallet_layout">
      <div class="wallet_dashboard_column">
        <div class="user_panel" id="wallet-dashboard">
          <strong class="sale_card_title"></strong><strong class="sale_card_price"></strong>
          <div style="clear: both;"></div>
          <div class="frog_img_cont">
            <img src="https://freshfrogs.github.io/assets/blackWhite.png" class="recent_sale_img" id="dashboard-avatar" alt="Wallet Avatar">
          </div>
          <div class="recent_sale_traits">
            <div class="user_panel_title">
              <strong id="dashboard-username" class="sale_card_title">Connect Ethereum Wallet</strong>
              <strong class="user_panel_address" id="dashboard-wallet">--</strong>
            </div>
            <div class="user_panel_prop" id="dashboard-badges">
              <div class="dashboard_badge">
                <span class="dashboard_badge_icon">üê∏</span>
                <div>
                  <span class="dashboard_badge_title">Collection</span>
                  <span class="dashboard_badge_desc"><span id="stat-owned">--</span> frogs discovered</span>
                </div>
              </div>
              <div class="dashboard_badge">
                <span class="dashboard_badge_icon">üåø</span>
                <div>
                  <span class="dashboard_badge_title">Staking</span>
                  <span class="dashboard_badge_desc"><span id="stat-staked">--</span> frogs earning Flyz</span>
                </div>
              </div>
              <div class="dashboard_badge">
                <span class="dashboard_badge_icon">üí∞</span>
                <div>
                  <span class="dashboard_badge_title">Rewards</span>
                  <span class="dashboard_badge_desc">
                    <span id="stat-rewards-available">--</span> Flyz ready ‚Ä¢
                    <span id="stat-rewards-earned">--</span> total earned
                  </span>
                </div>
              </div>
              <div class="dashboard_badge">
                <span class="dashboard_badge_icon">‚≠ê</span>
                <div>
                  <span class="dashboard_badge_title">Status</span>
                  <span class="dashboard_badge_desc">
                    Current rank: <span id="dashboard-role">New Explorer</span>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <span id="stat-rewards-available-inline" style="display: none;">--</span>
        <p id="dashboard-status" class="dashboard_status">Connect your wallet to load your dashboard.</p>
      </div>

      <div class="wallet_frogs_column">
        <div class="recent_sales" id="wallet-frogs">
          <p id="wallet-frogs-status" class="recent_sales_status">Waiting for wallet address...</p>
        </div>
      </div>
    </div>

    <!-- Your existing main site logic (if needed) -->
    <script src="assets/site.js"></script>

    <!-- 404-specific wallet-from-URL + Alchemy logic -->
    <script>
      (function () {
        'use strict';

        // ------------------------
        // Config ‚Äì these are your real values
        // ------------------------
        const FF_COLLECTION_ADDRESS = '0xBE4Bef8735107db540De269FF82c7dE9ef68C51b';
        // This is the same key you already use on the site
        const FF_ALCHEMY_API_KEY = 'C71cZZLIIjuEeWwP4s8zut6O3OGJGyoJ';
        const FF_ALCHEMY_NFT_BASE = 'https://eth-mainnet.g.alchemy.com/nft/v3/' + FF_ALCHEMY_API_KEY;

        // ------------------------
        // Helpers
        // ------------------------
        function $(id) {
          return document.getElementById(id);
        }

        function isValidEthAddress(addr) {
          return /^0x[a-fA-F0-9]{40}$/.test(addr);
        }

        function shortenAddress(addr) {
          if (!addr || addr.length < 11) return addr || '';
          return addr.slice(0, 6) + '...' + addr.slice(-4);
        }

        function getWalletFromPath() {
          // e.g. /0xabc... or /0xabc.../whatever
          var raw = window.location.pathname.replace(/^\/+|\/+$/g, '');
          if (!raw) return null;
          var first = raw.split('/')[0];
          if (isValidEthAddress(first)) return first;
          return null;
        }

        function setStatus(text) {
          var el = $('wallet-frogs-status');
          if (el) el.textContent = text;
        }

        // ------------------------
        // Alchemy: owned frogs by wallet
        // ------------------------
        async function fetchOwnedFrogs(walletAddress) {
          var frogs = [];
          var pageKey = null;

          try {
            do {
              var params = new URLSearchParams({
                owner: walletAddress,
                withMetadata: 'true',
                pageSize: '100'
              });
              params.append('contractAddresses[]', FF_COLLECTION_ADDRESS);
              if (pageKey) params.set('pageKey', pageKey);

              var url = FF_ALCHEMY_NFT_BASE + '/getNFTsForOwner?' + params.toString();
              var res = await fetch(url);

              if (!res.ok) {
                console.error('[FreshFrogs 404] Alchemy getNFTsForOwner failed', res.status, res.statusText);
                break;
              }

              var data = await res.json();
              var nfts = data.ownedNfts || data.nfts || [];

              for (var i = 0; i < nfts.length; i++) {
                var nft = nfts[i];
                var rawId = (nft.tokenId || '').toString();
                var tokenId = 0;
                if (rawId.startsWith('0x')) {
                  tokenId = parseInt(rawId, 16);
                } else {
                  tokenId = parseInt(rawId, 10);
                }

                var img =
                  (nft.image && (nft.image.cachedUrl || nft.image.pngUrl || nft.image.originalUrl)) ||
                  (nft.media && nft.media[0] && (nft.media[0].gateway || nft.media[0].raw)) ||
                  'https://freshfrogs.github.io/assets/blackWhite.png';

                var rarity = null;
                try {
                  if (window.RARITY_RANKINGS && tokenId in window.RARITY_RANKINGS) {
                    rarity = window.RARITY_RANKINGS[tokenId];
                  }
                } catch (e) {
                  // ignore
                }

                frogs.push({
                  tokenId: tokenId,
                  imageUrl: img,
                  rarity: rarity
                });
              }

              pageKey = data.pageKey || null;
            } while (pageKey);
          } catch (err) {
            console.error('[FreshFrogs 404] Error fetching owned frogs', err);
          }

          return frogs;
        }

        // ------------------------
        // Rendering
        // ------------------------
        function renderFrogCard(frog) {
          var container = $('wallet-frogs');
          var status = $('wallet-frogs-status');
          if (!container) return;

          if (status) {
            status.style.display = 'none';
          }

          var card = document.createElement('div');
          card.className = 'recent_sale_card';

          var imgCont = document.createElement('div');
          imgCont.className = 'frog_img_cont';

          var img = document.createElement('img');
          img.className = 'recent_sale_img';
          img.src = frog.imageUrl;
          img.alt = 'Fresh Frog #' + frog.tokenId;
          imgCont.appendChild(img);

          var traits = document.createElement('div');
          traits.className = 'recent_sale_traits';

          var headerRow = document.createElement('div');
          headerRow.className = 'recent_sale_title_row';

          var title = document.createElement('strong');
          title.className = 'sale_card_title';
          title.textContent = 'Fresh Frog #' + frog.tokenId;

          var tag = document.createElement('strong');
          tag.className = 'sale_card_price';
          tag.textContent = 'Owned üê∏';

          headerRow.appendChild(title);
          headerRow.appendChild(tag);

          var meta = document.createElement('div');
          meta.className = 'recent_sale_prop';

          if (frog.rarity != null) {
            var raritySpan = document.createElement('span');
            raritySpan.textContent = 'Rarity rank: #' + frog.rarity;
            meta.appendChild(raritySpan);
          }

          traits.appendChild(headerRow);
          traits.appendChild(meta);

          card.appendChild(imgCont);
          card.appendChild(traits);

          container.appendChild(card);
        }

        async function loadWalletView(walletAddress) {
          var shortAddr = shortenAddress(walletAddress);

          // Update "Currently viewing" line
          var addrSpan = $('wallet-address');
          if (addrSpan) {
            addrSpan.textContent = walletAddress;
            addrSpan.classList.remove('wallet_invalid');
            addrSpan.classList.add('wallet_valid');
          }

          // Update dashboard header
          var dashUser = $('dashboard-username');
          var dashWallet = $('dashboard-wallet');
          if (dashUser) dashUser.textContent = 'Wallet Viewer';
          if (dashWallet) dashWallet.textContent = shortAddr || walletAddress;

          // Reset stats
          var statOwned = $('stat-owned');
          var statStaked = $('stat-staked');
          if (statOwned) statOwned.textContent = '--';
          if (statStaked) statStaked.textContent = '0';

          var dashStatus = $('dashboard-status');
          if (dashStatus) {
            dashStatus.textContent = 'Loading frogs for ' + (shortAddr || walletAddress) + '...';
          }
          setStatus('Loading frogs for this wallet...');

          var container = $('wallet-frogs');
          if (container) {
            container.innerHTML = '';
            var p = document.createElement('p');
            p.id = 'wallet-frogs-status';
            p.className = 'recent_sales_status';
            p.textContent = 'Loading frogs for this wallet...';
            container.appendChild(p);
          }

          // Fetch owned frogs
          var owned = await fetchOwnedFrogs(walletAddress);
          if (!owned || !owned.length) {
            if (statOwned) statOwned.textContent = '0';
            setStatus('No Fresh Frogs found for this wallet.');
            if (dashStatus) {
              dashStatus.textContent = 'No frogs found for this wallet yet.';
            }
            return;
          }

          if (statOwned) statOwned.textContent = String(owned.length);
          if (dashStatus) {
            dashStatus.textContent = 'Loaded ' + owned.length + ' owned frogs.';
          }

          // Render them
          for (var i = 0; i < owned.length; i++) {
            renderFrogCard(owned[i]);
          }
        }

        // ------------------------
        // Init on page load
        // ------------------------
        document.addEventListener('DOMContentLoaded', function () {
          var walletAddress = getWalletFromPath();

          if (!walletAddress) {
            // No valid address in URL ‚Äì show default text
            var addrSpan = $('wallet-address');
            if (addrSpan) {
              addrSpan.textContent = 'No wallet detected';
              addrSpan.classList.remove('wallet_valid');
              addrSpan.classList.add('wallet_invalid');
            }
            setStatus('Waiting for wallet address...');
            return;
          }

          loadWalletView(walletAddress);
        });
      })();
    </script>
  </body>
</html>

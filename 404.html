<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FreshFrogs â€“ Wallet Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Match main site styles -->
  <link rel="stylesheet" href="style.css" />
  <link
    rel="shortcut icon"
    type="image/x-icon"
    href="https://freshfrogs.github.io/assets/blackWhite.png"
  />
</head>
<body class="layout-4">
  <div class="page">
    <!-- HEADER -->
    <header class="site-header">
      <nav class="nav">
        <!-- Views controlled by JS -->
        <a href="#" data-view="collection">Collection</a>
        <a href="#" data-view="rarity">Rarity</a>
        <a href="#" data-view="pond">Pond</a>
        <!-- Wallet tab appears AFTER connect, shows shortened address -->
        <a
          href="#"
          data-view="wallet"
          id="wallet-nav-link"
          style="display: none;"
        ></a>
      </nav>
    </header>

    <!-- DASHBOARD HERO -->
    <section class="hero">
      <div class="hero-main">
        <div class="hero-media">
          <img src="https://freshfrogs.github.io/frog/16.png" class="fly" />
          <img src="https://freshfrogs.github.io/frog/678.png" class="fly" />
          <img src="https://freshfrogs.github.io/frog/31.png" class="fly" />
          <img src="https://freshfrogs.github.io/frog/594.png" class="fly" />
        </div>
        <h1 class="hero-title">freshfrogs.github.io</h1>
        <p class="hero-subtitle">
          A collection of 4,040 randomly generated frogs on the Ethereum
          blockchain, that are each unique with thousands of different
          combinations!
          Stake and earn rewards, level up, unlock custom trait animations and
          more! All secondary sales are entitled to a <b>5%</b> royalty.
        </p>
        <div class="hero-actions">
          <button class="btn primary" id="hero-view-collection-btn">
            View Collection
          </button>
          <!-- This is the main connect button (still works normally) -->
          <button class="btn secondary" id="hero-connect-wallet-btn">
            Connect Wallet
          </button>
        </div>
      </div>
    </section>

    <!-- MAIN DASHBOARD LAYOUT -->
    <main class="dashboard-main">
      <!-- Recent Activity (sales / mints) -->
      <section
        class="panel dashboard-section"
        id="recent-activity-panel"
        style="background: transparent; box-shadow: none; padding: 0;"
      >
        <h2>Recent Activity</h2>
        <p class="dashboard-note" id="recent-sales-status">
          Loading recent sales...
        </p>

        <div class="recent_sales" id="recent-sales"></div>

        <button id="load-more-activity" class="btn secondary" type="button">
          Load More
        </button>
      </section>

      <!-- Rarity Rankings -->
      <section
        class="panel dashboard-section"
        id="rarity-panel"
        style="display:none; background: transparent; box-shadow: none; padding: 0;"
      >
        <h2>Rarity Rankings</h2>
        <p class="dashboard-note" id="rarity-status">
          Top ranked Frogs across the collection (lower rank = rarer).
        </p>

        <div id="rarity-grid" class="recent_sales"></div>

        <button id="load-more-rarity" class="btn secondary" type="button">
          Load More
        </button>
      </section>

      <!-- Pond -->
      <section
        class="panel dashboard-section"
        id="pond-panel"
        style="display:none; background: transparent; box-shadow: none; padding: 0;"
      >
        <h2>The Pond</h2>
        <p class="dashboard-note" id="pond-status">
          All Frogs currently staked by the community.
        </p>

        <div id="pond-grid" class="recent_sales"></div>

        <button id="load-more-pond" class="btn secondary" type="button">
          Load More
        </button>
      </section>

      <!-- Owned Frogs (wallet view; stacked vertically) -->
      <section
        class="panel dashboard-section"
        id="owned-panel"
        style="display:none; background: transparent; box-shadow: none; padding: 0;"
      >
        <h2>Owned Frogs</h2>
        <p class="dashboard-note" id="owned-frogs-status">
          These are Frogs currently held in your wallet.
        </p>

        <div id="owned-frogs-grid" class="nft-grid"></div>
      </section>

      <!-- Staked Frogs (wallet view; BELOW owned frogs) -->
      <section
        class="panel dashboard-section"
        id="staked-panel"
        style="display:none; background: transparent; box-shadow: none; padding: 0;"
      >
        <h2>Staked Frogs</h2>
        <p class="dashboard-note" id="staked-frogs-status">
          These Frogs are staked in the FreshFrogs controller.
        </p>

        <div id="staked-frogs-grid" class="nft-grid"></div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="site-footer">
      <span class="footer-links" style="color: white;">
        <a href="#">freshfrogs.github.io</a>
      </span>
    </footer>
  </div>

  <!-- Web3 for wallet / staking functions -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

  <!-- ABIs + legacy staking helpers (used for staking level / progress) -->
  <script src="https://freshfrogs.github.io/assets/collection_abi.js"></script>
  <script src="https://freshfrogs.github.io/assets/controller_abi.js"></script>
  <script src="https://freshfrogs.github.io/assets/ethereum-dapp.js"></script>

  <!-- Rarity rankings (must load before site.js) -->
  <script src="https://freshfrogs.github.io/assets/rarityrankings.js"></script>

  <!-- Main site logic (recent activity, wallet, dashboard, etc.) -->
  <script src="https://freshfrogs.github.io/assets/site.js"></script>

  <!-- 404-specific wallet-from-URL logic -->
  <script>
    (function () {
      'use strict';

      // ------------------------
      // Config â€“ update API key
      // ------------------------
      const FF_COLLECTION_ADDRESS = '0xBE4Bef8735107db540De269FF82c7dE9ef68C51b';
      const FF_ALCHEMY_API_KEY = 'YOUR_ALCHEMY_API_KEY_HERE'; // TODO: set this
      const FF_ALCHEMY_NFT_BASE =
        'https://eth-mainnet.g.alchemy.com/nft/v3/' + FF_ALCHEMY_API_KEY;

      // ------------------------
      // Helpers
      // ------------------------
      function $(id) {
        return document.getElementById(id);
      }

      function isValidEthAddress(addr) {
        return /^0x[a-fA-F0-9]{40}$/.test(addr);
      }

      function shortenAddress(addr) {
        if (!addr || addr.length < 11) return addr || '';
        return addr.slice(0, 6) + '...' + addr.slice(-4);
      }

      function getWalletFromPath() {
        // e.g. /0xabc... => "0xabc..."
        var raw = window.location.pathname.replace(/^\/+|\/+$/g, '');
        if (!raw) return null;
        var first = raw.split('/')[0];
        if (isValidEthAddress(first)) return first;
        return null;
      }

      // ------------------------
      // Alchemy: owned frogs (by wallet)
      // ------------------------
      async function fetchOwnedFrogs(walletAddress) {
        if (
          !FF_ALCHEMY_API_KEY ||
          FF_ALCHEMY_API_KEY === 'YOUR_ALCHEMY_API_KEY_HERE'
        ) {
          console.warn(
            '[FreshFrogs] 404 wallet view: set FF_ALCHEMY_API_KEY in 404.html'
          );
          return [];
        }

        var frogs = [];
        var pageKey = null;

        try {
          do {
            var params = new URLSearchParams({
              owner: walletAddress,
              withMetadata: 'true',
              pageSize: '100'
            });
            params.append('contractAddresses[]', FF_COLLECTION_ADDRESS);
            if (pageKey) params.set('pageKey', pageKey);

            var url = FF_ALCHEMY_NFT_BASE + '/getNFTsForOwner?' + params.toString();
            var res = await fetch(url);

            if (!res.ok) {
              console.error(
                '[FreshFrogs] Alchemy getNFTsForOwner failed',
                res.status,
                res.statusText
              );
              break;
            }

            var data = await res.json();
            var nfts = data.ownedNfts || data.nfts || [];

            for (var i = 0; i < nfts.length; i++) {
              var nft = nfts[i];
              var rawId = (nft.tokenId || '').toString();
              var tokenId = 0;
              if (rawId.startsWith('0x')) {
                tokenId = parseInt(rawId, 16);
              } else {
                tokenId = parseInt(rawId, 10);
              }

              var img =
                (nft.image && (nft.image.cachedUrl || nft.image.pngUrl || nft.image.originalUrl)) ||
                (nft.media &&
                  nft.media[0] &&
                  (nft.media[0].gateway || nft.media[0].raw)) ||
                'https://freshfrogs.github.io/assets/blackWhite.png';

              var rarity = null;
              try {
                if (window.RARITY_RANKINGS && tokenId in window.RARITY_RANKINGS) {
                  rarity = window.RARITY_RANKINGS[tokenId];
                }
              } catch (e) {
                // ignore
              }

              frogs.push({
                tokenId: tokenId,
                imageUrl: img,
                rarity: rarity,
                source: 'owned'
              });
            }

            pageKey = data.pageKey || null;
          } while (pageKey);
        } catch (err) {
          console.error('[FreshFrogs] Error fetching owned frogs', err);
        }

        return frogs;
      }

      // ------------------------
      // Staked frogs stub â€“ plug in your staking logic later
      // ------------------------
      async function fetchStakedFrogs(_walletAddress) {
        // TODO: replace this stub with real staking lookup
        // (e.g., using your controller contract / ethereum-dapp.js helpers)
        return [];
      }

      // ------------------------
      // Rendering
      // ------------------------
      function renderFrogCard(frog, gridId) {
        var grid = $(gridId);
        if (!grid) return;

        var card = document.createElement('div');
        card.className = 'recent_sale_card nft-card';

        var imgCont = document.createElement('div');
        imgCont.className = 'frog_img_cont';

        var img = document.createElement('img');
        img.className = 'recent_sale_img';
        img.src = frog.imageUrl;
        img.alt = 'Fresh Frog #' + frog.tokenId;
        imgCont.appendChild(img);

        var traits = document.createElement('div');
        traits.className = 'recent_sale_traits';

        var headerRow = document.createElement('div');
        headerRow.className = 'recent_sale_title_row';

        var title = document.createElement('strong');
        title.className = 'sale_card_title';
        title.textContent = 'Fresh Frog #' + frog.tokenId;

        var tag = document.createElement('strong');
        tag.className = 'sale_card_price';
        tag.textContent = frog.source === 'staked' ? 'Staked ðŸŸ¢' : 'Owned ðŸ¸';

        headerRow.appendChild(title);
        headerRow.appendChild(tag);

        var meta = document.createElement('div');
        meta.className = 'recent_sale_prop';

        if (frog.rarity != null) {
          var raritySpan = document.createElement('span');
          raritySpan.textContent = 'Rarity rank: #' + frog.rarity;
          meta.appendChild(raritySpan);
        }

        traits.appendChild(headerRow);
        traits.appendChild(meta);

        card.appendChild(imgCont);
        card.appendChild(traits);

        grid.appendChild(card);
      }

      async function loadWalletView(walletAddress) {
        var shortAddr = shortenAddress(walletAddress);

        // Show wallet tab with address
        var walletNav = $('wallet-nav-link');
        if (walletNav) {
          walletNav.style.display = 'inline-block';
          walletNav.textContent = shortAddr || walletAddress;
        }

        // Panels: hide collection/rarity/pond, show owned + staked
        var collectionPanel = $('recent-activity-panel');
        var rarityPanel = $('rarity-panel');
        var pondPanel = $('pond-panel');
        var ownedPanel = $('owned-panel');
        var stakedPanel = $('staked-panel');

        if (collectionPanel) collectionPanel.style.display = 'none';
        if (rarityPanel) rarityPanel.style.display = 'none';
        if (pondPanel) pondPanel.style.display = 'none';
        if (ownedPanel) ownedPanel.style.display = 'block';
        if (stakedPanel) stakedPanel.style.display = 'block';

        var ownedStatus = $('owned-frogs-status');
        var stakedStatus = $('staked-frogs-status');

        if (ownedStatus)
          ownedStatus.textContent =
            'Loading frogs for ' + (shortAddr || walletAddress) + '...';
        if (stakedStatus)
          stakedStatus.textContent =
            'Loading staked frogs for ' + (shortAddr || walletAddress) + '...';

        // Fetch data
        var results = await Promise.all([
          fetchOwnedFrogs(walletAddress),
          fetchStakedFrogs(walletAddress)
        ]);

        var owned = results[0] || [];
        var staked = results[1] || [];

        var ownedGrid = $('owned-frogs-grid');
        var stakedGrid = $('staked-frogs-grid');
        if (ownedGrid) ownedGrid.innerHTML = '';
        if (stakedGrid) stakedGrid.innerHTML = '';

        if (!owned.length) {
          if (ownedStatus)
            ownedStatus.textContent =
              'No owned Fresh Frogs found for this wallet.';
        } else {
          if (ownedStatus)
            ownedStatus.textContent =
              'Showing ' + owned.length + ' owned Fresh Frogs.';
          owned.forEach(function (frog) {
            renderFrogCard(frog, 'owned-frogs-grid');
          });
        }

        if (!staked.length) {
          if (stakedStatus)
            stakedStatus.textContent =
              'No staked Fresh Frogs found for this wallet.';
        } else {
          if (stakedStatus)
            stakedStatus.textContent =
              'Showing ' + staked.length + ' staked Fresh Frogs.';
          staked.forEach(function (frog) {
            renderFrogCard(frog, 'staked-frogs-grid');
          });
        }
      }

      // ------------------------
      // Init on 404 load
      // ------------------------
      document.addEventListener('DOMContentLoaded', function () {
        var walletAddress = getWalletFromPath();
        if (!walletAddress) {
          // No address in URL â€“ behave like normal homepage
          return;
        }
        if (
          !FF_ALCHEMY_API_KEY ||
          FF_ALCHEMY_API_KEY === 'YOUR_ALCHEMY_API_KEY_HERE'
        ) {
          console.warn(
            '[FreshFrogs] 404 wallet view: set FF_ALCHEMY_API_KEY in 404.html'
          );
          return;
        }
        loadWalletView(walletAddress);
      });
    })();
  </script>
</body>
</html>

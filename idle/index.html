<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FreshFrog Idle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />

  <style>
    body{ margin:0; background:#05070a; color:#e6f0ff; font-family:system-ui,Segoe UI,Roboto,Arial;}
    header{ position:sticky; top:0; background:#0d121a; border-bottom:1px solid #1e2a3d; padding:10px 12px; display:flex; align-items:center; gap:10px;}
    button{ background:#121823; color:#e6f0ff; border:1px solid #24324a; padding:7px 10px; border-radius:10px; cursor:pointer;}
    button:hover{ border-color:#3b4f72;}
    #wrap{ display:grid; grid-template-columns:300px 1fr; gap:12px; padding:12px; }
    #left{ background:#121823; border:1px solid #1c2940; border-radius:14px; padding:10px; height:calc(100vh - 86px); overflow:auto;}
    #game{ background:#121823; border:1px solid #1c2940; border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:10px; align-items:center;}
    .frogRow{ display:flex; align-items:center; gap:8px; padding:6px; border-radius:10px; background:#0f1520; border:1px solid #1c2940; margin-bottom:6px; cursor:pointer;}
    .frogRow:hover{ border-color:#3b4f72;}
    .frogRow img{ width:44px; height:44px; image-rendering:pixelated; border-radius:8px; background:#000;}
    .pill{ font-size:12px; padding:2px 6px; border:1px solid #2b3b55; border-radius:999px; color:#8aa0c2; }
    .small{ font-size:12px; color:#8aa0c2;}
    .big{ font-size:30px; font-weight:900; }
    #clickFrog{ width:180px; height:180px; image-rendering:pixelated; border-radius:16px; background:#000; cursor:pointer; }
    #upgrades{ width:100%; display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px;}
    .upg{ background:#0f1520; border:1px solid #1c2940; border-radius:12px; padding:8px; cursor:pointer;}
    .upg:hover{ border-color:#3b4f72;}
    .row{ display:flex; align-items:center; justify-content:space-between; width:100%; }
  </style>

  <script>window.FF_PAGE="idle";</script>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script src="https://freshfrogs.github.io/assets/collection_abi.js"></script>
  <script src="https://freshfrogs.github.io/assets/controller_abi.js"></script>
  <script src="https://freshfrogs.github.io/assets/ethereum-dapp.js"></script>
  <script src="https://freshfrogs.github.io/assets/rarityrankings.js"></script>
  <script src="https://freshfrogs.github.io/assets/site.js"></script>
</head>
<body>

<header>
  <button id="connectBtn">Connect Wallet</button>
  <div id="addr" class="pill">not connected</div>
  <div class="pill">FreshFrog Idle</div>
</header>

<div id="wrap">
  <aside id="left">
    <div class="row">
      <h3 style="margin:0;">Choose a Frog</h3>
      <button id="mockBtn">Mock Frogs</button>
    </div>
    <div class="small">Selected Frog boosts your FLYZ.</div>
    <div id="frogList" style="margin-top:8px;"></div>
  </aside>

  <main id="game">
    <div class="small">Selected Frog</div>
    <div id="selectedName" style="font-weight:800;">none</div>

    <img id="clickFrog" src="https://freshfrogs.github.io/assets/blackWhite.png"/>

    <div class="big"><span id="flyzTxt">0</span> FLYZ</div>
    <div class="small">per click: <span id="pcTxt">1</span> â€¢ per sec: <span id="psTxt">0</span></div>

    <div id="upgrades"></div>

    <div id="log" class="small"></div>
  </main>
</div>

<script>
/* ============ normalize + fetch ============ */
function normalizeFrog(raw){
  const tokenId = Number(raw.tokenId ?? raw.id ?? raw.token_id);
  const metadata = raw.metadata || raw.rawMetadata || raw;
  const traits = metadata?.attributes || metadata?.traits || [];
  return {
    tokenId,
    name: metadata?.name || raw.name || `Frog #${tokenId}`,
    image: raw.image || metadata?.image || `https://freshfrogs.github.io/frog/${tokenId}.png`,
    rarityTier: (window.getRarityTier && window.getRarityRank)
      ? (getRarityTier(getRarityRank(tokenId))?.label || "Common")
      : "Common",
    traits
  };
}

async function fetchPlayableFrogs(address){
  const owned = await window.ffFetchOwnedFrogs(address);
  const stakedIds = await window.ffFetchStakedTokenIds(address).catch(()=>[]);
  const morphed = await window.ffFetchMorphedFrogs(address).catch(()=>[]);
  const stakedNfts = await Promise.all(stakedIds.map(id=>window.fetchFrogMetadata(id).then(m=>({tokenId:id, metadata:m}))));
  const allRaw = [...owned, ...stakedNfts, ...morphed.map((m,i)=>({ tokenId: 900000+i, metadata:m, image:m.image }))];

  const out=[], seen=new Set();
  for(const r of allRaw){
    const f=normalizeFrog(r);
    if(!seen.has(f.tokenId)){ seen.add(f.tokenId); out.push(f); }
  }
  return out;
}

/* ============ game state ============ */
const ui={
  connectBtn:document.getElementById("connectBtn"),
  addr:document.getElementById("addr"),
  frogList:document.getElementById("frogList"),
  selectedName:document.getElementById("selectedName"),
  clickFrog:document.getElementById("clickFrog"),
  flyzTxt:document.getElementById("flyzTxt"),
  pcTxt:document.getElementById("pcTxt"),
  psTxt:document.getElementById("psTxt"),
  upgrades:document.getElementById("upgrades"),
  mockBtn:document.getElementById("mockBtn"),
  log:document.getElementById("log"),
};
function log(m){ ui.log.textContent=m; }

let address=null,frogs=[],selected=null;

// saved run
const SAVE_KEY="ff_idle_save";
let save = loadSave();
let flyz=save.flyz||0;
let perClick=save.perClick||1;
let perSec=save.perSec||0;
let mult=1;

const UPGS=[
  {id:"tongue", name:"Longer Tongue", base:20, incPC:1},
  {id:"pond", name:"Pond Farm", base:50, incPS:1},
  {id:"flies", name:"Fly Magnet", base:120, multPC:1.15},
  {id:"hops", name:"Power Hops", base:180, multPS:1.2},
];

function loadSave(){
  try{ return JSON.parse(localStorage.getItem(SAVE_KEY)||"{}"); }catch{ return {}; }
}
function persist(){
  localStorage.setItem(SAVE_KEY, JSON.stringify({flyz,perClick,perSec,up:save.up||{}}));
}
function priceFor(up){
  const lvl=(save.up?.[up.id]||0);
  return Math.floor(up.base*Math.pow(1.35,lvl));
}

function applyFrogBoosts(f){
  mult=1;
  perClick=save.perClick||1;
  perSec=save.perSec||0;

  const tvals=(f.traits||[]).map(t=>String(t.value||"").toLowerCase());
  if(tvals.some(v=>v.includes("cyber")||v.includes("ninja"))) perClick*=1.1;
  if(tvals.some(v=>v.includes("crown")||v.includes("wizard"))) perSec*=1.1;
  if(tvals.some(v=>v.includes("armor")||v.includes("zombie"))) mult*=1.05;

  const tier=String(f.rarityTier||"common").toLowerCase();
  if(tier.includes("rare")) mult*=1.05;
  if(tier.includes("epic")) mult*=1.12;
  if(tier.includes("legendary")) mult*=1.2;

  perClick=Math.floor(perClick*mult);
  perSec=+(perSec*mult).toFixed(2);
}

/* ============ UI render ============ */
function renderHUD(){
  ui.flyzTxt.textContent=Math.floor(flyz);
  ui.pcTxt.textContent=perClick;
  ui.psTxt.textContent=perSec.toFixed(2);
}

function renderUpgrades(){
  ui.upgrades.innerHTML="";
  for(const up of UPGS){
    const lvl=(save.up?.[up.id]||0);
    const cost=priceFor(up);
    const div=document.createElement("div");
    div.className="upg";
    div.innerHTML=`
      <div style="font-weight:800;">${up.name} (lvl ${lvl})</div>
      <div class="small">cost: ${cost} FLYZ</div>
      <div class="small">${
        up.incPC?`+${up.incPC} per click`:
        up.incPS?`+${up.incPS} per sec`:
        up.multPC?`${Math.round((up.multPC-1)*100)}% click power`:
        `${Math.round((up.multPS-1)*100)}% idle power`
      }</div>
    `;
    div.onclick=()=>{
      if(flyz<cost) return log("Not enough FLYZ.");
      flyz-=cost;
      save.up=save.up||{};
      save.up[up.id]=lvl+1;
      // apply effect
      if(up.incPC) perClick+=up.incPC;
      if(up.incPS) perSec+=up.incPS;
      if(up.multPC) perClick=Math.floor(perClick*up.multPC);
      if(up.multPS) perSec=+(perSec*up.multPS).toFixed(2);

      save.perClick=perClick; save.perSec=perSec;
      persist(); renderHUD(); renderUpgrades();
      log("Upgraded!");
    };
    ui.upgrades.appendChild(div);
  }
}

/* ============ loop ============ */
let last=performance.now();
function tick(t){
  const dt=(t-last)/1000; last=t;
  flyz+=perSec*dt;
  renderHUD();
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

ui.clickFrog.onclick=()=>{
  flyz+=perClick;
  persist(); renderHUD();
};

ui.connectBtn.onclick = async ()=>{
  try{
    if(!window.ethereum?.request) throw new Error("No wallet provider.");

    if(typeof window.connectWallet==="function"){
      await window.connectWallet();
      address=(window.FF_CONNECTED_ADDRESS||window.user_address||"").toLowerCase();
    }else{
      const [a]=await ethereum.request({method:"eth_requestAccounts"});
      address=(a||"").toLowerCase();
    }
    if(!address) throw new Error("No address returned.");

    ui.addr.textContent=address.slice(0,6)+"..."+address.slice(-4);

    frogs = await fetchPlayableFrogs(address);
    renderFrogList();
    log("Wallet connected.");
  }catch(e){
    console.error(e);
    log(e.message||String(e));
  }
};

ui.mockBtn.onclick=()=>{
  frogs=[
    {tokenId:12,name:"Frog #12",image:"https://freshfrogs.github.io/frog/12.png",rarityTier:"Rare",traits:[{value:"Cyber Eyes"}]},
    {tokenId:666,name:"Frog #666",image:"https://freshfrogs.github.io/frog/666.png",rarityTier:"Epic",traits:[{value:"Wizard Hat"}]},
  ];
  renderFrogList();
};

function renderFrogList(){
  ui.frogList.innerHTML="";
  if(!frogs.length){
    ui.frogList.innerHTML=`<div class="small">No frogs found.</div>`;
    return;
  }
  for(const f of frogs){
    const row=document.createElement("div");
    row.className="frogRow";
    row.innerHTML=`
      <img src="${f.image}"/>
      <div style="flex:1;">
        <div style="font-weight:700;">${f.name}</div>
        <div class="small">${f.rarityTier||"Common"}</div>
      </div>
      <div class="pill">#${f.tokenId}</div>
    `;
    row.onclick=()=>{
      selected=f;
      ui.selectedName.textContent=f.name;
      ui.clickFrog.src=f.image;
      applyFrogBoosts(f);
      save.perClick=perClick; save.perSec=perSec;
      persist(); renderHUD(); renderUpgrades();
      log("Selected frog boosts applied!");
    };
    ui.frogList.appendChild(row);
  }
}

// boot UI
renderHUD(); renderUpgrades();
</script>
</body>
</html>

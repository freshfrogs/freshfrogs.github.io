<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FreshFrog Runner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link rel="stylesheet" href="/style.css" />

  <style>
    :root{
      --bg:#05070a; --panel:#121823; --panel2:#0f1520;
      --txt:#e6f0ff; --muted:#8aa0c2; --line:#1c2940; --accent:#37e07b;
    }
    body{ margin:0; background:var(--bg); color:var(--txt); font-family:system-ui,Segoe UI,Roboto,Arial;}
    header{ position:sticky; top:0; z-index:10; background:#0d121a; border-bottom:1px solid #1e2a3d; padding:10px 12px; display:flex; align-items:center; gap:10px;}
    button{ background:var(--panel); color:var(--txt); border:1px solid #24324a; padding:7px 10px; border-radius:10px; cursor:pointer; }
    button:hover{ border-color:#3b4f72;}
    #wrap{ display:grid; grid-template-columns:300px 1fr; gap:12px; padding:12px; }
    #left{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:10px; height:calc(100vh - 86px); overflow:auto;}
    #game{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:10px; display:flex; flex-direction:column; gap:8px;}
    canvas{
      width:100%; height:520px; background:#020408; border-radius:12px; border:1px solid var(--line);
      image-rendering:pixelated;
    }
    .frogRow{ display:flex; align-items:center; gap:8px; padding:6px; border-radius:10px; background:var(--panel2); border:1px solid var(--line); margin-bottom:6px; cursor:pointer;}
    .frogRow:hover{ border-color:#3b4f72;}
    .frogRow img{ width:44px; height:44px; image-rendering:pixelated; border-radius:8px; background:#000;}
    .pill{ font-size:12px; padding:2px 6px; border:1px solid #2b3b55; border-radius:999px; color:var(--muted); }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .small{ font-size:12px; color:var(--muted);}
  </style>

  <script>window.FF_PAGE="runner";</script>

  <!-- Same load order as main index -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script src="https://freshfrogs.github.io/assets/collection_abi.js"></script>
  <script src="https://freshfrogs.github.io/assets/controller_abi.js"></script>
  <script src="https://freshfrogs.github.io/assets/ethereum-dapp.js"></script>
  <script src="https://freshfrogs.github.io/assets/rarityrankings.js"></script>
  <script src="https://freshfrogs.github.io/assets/site.js"></script>
</head>
<body>

<header>
  <button id="connectBtn">Connect Wallet</button>
  <div id="addr" class="pill">not connected</div>
  <div class="pill">FreshFrog Runner</div>
</header>

<div id="wrap">
  <aside id="left">
    <div class="row">
      <h3 style="margin:0;">Choose a Frog</h3>
      <button id="mockBtn">Mock Frogs</button>
    </div>
    <div class="small">Your selected Frog becomes the runner.</div>
    <div id="frogList" style="margin-top:8px;"></div>
  </aside>

  <main id="game">
    <div class="row">
      <div>
        <div class="small">Selected Frog</div>
        <div id="selectedName" style="font-weight:800;">none</div>
      </div>
      <div class="row">
        <div class="pill">Score: <span id="scoreTxt">0</span></div>
        <div class="pill">Best: <span id="bestTxt">0</span></div>
        <button id="startBtn" disabled>Start</button>
        <button id="resetBtn">Reset</button>
      </div>
    </div>

    <canvas id="c" width="1000" height="520"></canvas>
    <div id="log" class="small"></div>
  </main>
</div>

<script>
/* ===============================
   Normalize + Fetch (fixed)
   =============================== */

function normalizeFrog(raw){
  const parse = (typeof window.parseTokenId === "function")
    ? window.parseTokenId
    : (v)=> {
        if (v == null) return null;
        if (typeof v === "string" && v.startsWith("0x")) return parseInt(v,16);
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      };

  const tokenId =
    parse(raw?.tokenId) ??
    parse(raw?.id?.tokenId) ??
    parse(raw?.token_id) ??
    parse(raw?.nft?.identifier);

  if (tokenId == null) return null;

  const metadata = raw.rawMetadata || raw.metadata || raw.tokenMetadata || raw;
  const traits = metadata?.attributes || metadata?.traits || [];

  return {
    tokenId,
    name: metadata?.name || raw.name || `Frog #${tokenId}`,
    image: `https://freshfrogs.github.io/frog/${tokenId}.png`,
    rarityTier: (window.getRarityTier && window.getRarityRank)
      ? (getRarityTier(getRarityRank(tokenId))?.label || "Common")
      : "Common",
    traits
  };
}

async function fetchPlayableFrogs(address){
  const [ownedNfts, stakedIds, morphedMetas] = await Promise.all([
    window.ffFetchOwnedFrogs(address),                         // :contentReference[oaicite:4]{index=4}
    window.ffFetchStakedTokenIds(address).catch(()=>[]),       // :contentReference[oaicite:5]{index=5}
    window.ffFetchMorphedFrogs(address).catch(()=>[])          // :contentReference[oaicite:6]{index=6}
  ]);

  // If any owned lack usable metadata, follow your site pattern and fetch it
  const owned = [];
  for (const nft of ownedNfts){
    const f = normalizeFrog(nft);
    if (!f) continue;
    if (!f.traits?.length && typeof window.fetchFrogMetadata === "function") {
      const meta = await window.fetchFrogMetadata(f.tokenId);  // :contentReference[oaicite:7]{index=7}
      f.traits = meta?.attributes || meta?.traits || [];
      f.name = meta?.name || f.name;
    }
    owned.push(f);
  }

  const staked = stakedIds.map(id => normalizeFrog({ tokenId:id })).filter(Boolean);
  const morphed = (morphedMetas||[]).map((meta,i)=>({
    tokenId: 900000+i,
    name: meta?.name || "Morphed Frog",
    image: meta?.image || meta?.image_url || "https://freshfrogs.github.io/assets/blackWhite.png",
    rarityTier: "Morphed",
    traits: meta?.attributes || meta?.traits || []
  }));

  const all=[...owned,...staked,...morphed];
  const seen=new Set();
  return all.filter(f=>!seen.has(f.tokenId) && seen.add(f.tokenId));
}

/* ===============================
   Runner Game (visual pass)
   =============================== */

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

const ui = {
  connectBtn: document.getElementById("connectBtn"),
  addr: document.getElementById("addr"),
  frogList: document.getElementById("frogList"),
  selectedName: document.getElementById("selectedName"),
  startBtn: document.getElementById("startBtn"),
  resetBtn: document.getElementById("resetBtn"),
  mockBtn: document.getElementById("mockBtn"),
  scoreTxt: document.getElementById("scoreTxt"),
  bestTxt: document.getElementById("bestTxt"),
  log: document.getElementById("log"),
};

let address=null, frogs=[], selected=null;

let running=false, score=0;
let best=+localStorage.getItem("ff_runner_best")||0;
ui.bestTxt.textContent=best;

const groundY=420;
let speed=230, gravity=1850, jumpVel=660, magnet=0;

let player=null, obstacles=[], coins=[];
let lastT=performance.now(), spawnTimer=0, coinTimer=0, bgScroll=0;

function log(msg){ ui.log.textContent=msg; }

function applyTraitBonuses(frog){
  const tvals=(frog.traits||[]).map(t=>String(t.value||t.trait_value||"").toLowerCase());
  speed=230; jumpVel=660; magnet=0;

  if(tvals.some(v=>v.includes("ninja")||v.includes("cyber"))) speed*=1.10;
  if(tvals.some(v=>v.includes("crown")||v.includes("wizard"))) magnet=110;
  if(tvals.some(v=>v.includes("armor")||v.includes("zombie"))) jumpVel*=1.07;

  const tier=String(frog.rarityTier||"common").toLowerCase();
  if(tier.includes("rare")) speed*=1.05;
  if(tier.includes("epic")) speed*=1.10;
  if(tier.includes("legendary")) speed*=1.18;
}

function resetRun(){
  running=false; score=0; obstacles=[]; coins=[]; player=null;
  ui.scoreTxt.textContent=0; log("Reset.");
}

function startRun(){
  if(!selected) return;
  applyTraitBonuses(selected);

  player={
    x:170, y:groundY, vy:0, w:70, h:70,
    img:(()=>{const im=new Image(); im.src=selected.image; return im;})()
  };
  obstacles=[]; coins=[]; score=0; spawnTimer=0; coinTimer=0; bgScroll=0;
  running=true; log("GO! Space / tap to jump.");
}

function spawnObstacle(){
  const type=Math.random();
  const h = type<0.5 ? 42 : 60;
  const w = type<0.5 ? 34 : 50;
  obstacles.push({
    x: canvas.width+30,
    y: groundY-h+8,
    w, h,
    spike: type>=0.5
  });
}

function spawnCoin(){
  coins.push({
    x: canvas.width+30,
    y: 230 + Math.random()*150,
    r: 10
  });
}

function jump(){
  if(!running||!player) return;
  if(player.y>=groundY-1) player.vy=-jumpVel;
}

function update(dt){
  if(!running||!player) return;

  bgScroll += speed*dt*0.5;

  player.vy += gravity*dt;
  player.y  += player.vy*dt;
  if(player.y>groundY){ player.y=groundY; player.vy=0; }

  spawnTimer+=dt; coinTimer+=dt;
  if(spawnTimer>1.1+Math.random()*0.8){ spawnTimer=0; spawnObstacle(); }
  if(coinTimer>0.65+Math.random()*0.6){ coinTimer=0; spawnCoin(); }

  for(const o of obstacles) o.x -= speed*dt;
  obstacles=obstacles.filter(o=>o.x+o.w>0);

  for(const c of coins){
    c.x -= speed*dt;
    if(magnet>0){
      const dx=(player.x+player.w/2)-c.x;
      const dy=(player.y-player.h/2)-c.y;
      const d=Math.hypot(dx,dy);
      if(d<magnet){
        c.x += dx/d*260*dt;
        c.y += dy/d*260*dt;
      }
    }
  }

  const px=player.x, py=player.y-player.h, pw=player.w, ph=player.h;

  for(const o of obstacles){
    if(px<o.x+o.w && px+pw>o.x && py<o.y+o.h && py+ph>o.y){
      running=false;
      best=Math.max(best, score|0);
      localStorage.setItem("ff_runner_best", best);
      ui.bestTxt.textContent=best;
      log("RIP. Hit an obstacle.");
      return;
    }
  }

  coins=coins.filter(c=>{
    if(c.x>px && c.x<px+pw && c.y>py && c.y<py+ph){
      score+=8; return false;
    }
    return c.x+c.r>0;
  });

  score += dt*5;
  ui.scoreTxt.textContent = score|0;
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // sky
  ctx.fillStyle="#050a12";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // parallax swamp bands
  for(let layer=0; layer<3; layer++){
    const y=80+layer*70;
    const bandH=60;
    const par=(layer+1)*0.35;
    const off=-(bgScroll*par)%120;
    ctx.fillStyle= layer===0 ? "#0a1522" : layer===1 ? "#07101a" : "#050b12";
    for(let x=off; x<canvas.width; x+=120){
      ctx.fillRect(x, y, 80, bandH);
    }
  }

  // lane lines
  ctx.strokeStyle="#0f1b2a";
  for(let i=0;i<canvas.width;i+=60){
    ctx.beginPath();
    ctx.moveTo(i, groundY+6);
    ctx.lineTo(i+30, groundY+6);
    ctx.stroke();
  }

  // ground
  ctx.fillStyle="#07131e";
  ctx.fillRect(0, groundY+6, canvas.width, canvas.height-groundY);

  // obstacles
  for(const o of obstacles){
    ctx.fillStyle = o.spike ? "#ff7a7a" : "#c9a66b";
    ctx.fillRect(o.x, o.y, o.w, o.h);
    if(o.spike){
      ctx.fillStyle="#2b0d0d";
      ctx.fillRect(o.x+6, o.y+8, o.w-12, 8);
    }
  }

  // coins (flies)
  for(const c of coins){
    ctx.fillStyle="#ffd36a";
    ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#000";
    ctx.fillRect(c.x-2,c.y-2,4,4);
  }

  // player sprite
  if(player){
    const drawY=player.y-player.h;
    try{ ctx.drawImage(player.img, player.x, drawY, player.w, player.h); }
    catch{
      ctx.fillStyle= "#37e07b";
      ctx.fillRect(player.x, drawY, player.w, player.h);
    }
  }

  // text
  ctx.fillStyle="#8aa0c2";
  ctx.fillText("SPACE / TAP to jump", 12, 18);
}

function loop(t){
  const dt=(t-lastT)/1000; lastT=t;
  update(dt); render();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ===============================
   UI
   =============================== */

ui.connectBtn.onclick = async ()=>{
  try{
    if(!window.ethereum?.request) throw new Error("No wallet provider.");

    if(typeof window.connectWallet==="function"){
      await window.connectWallet();
      address=(window.FF_CONNECTED_ADDRESS||window.user_address||"").toLowerCase();
    }else{
      const [a]=await ethereum.request({method:"eth_requestAccounts"});
      address=(a||"").toLowerCase();
    }
    if(!address) throw new Error("No address returned.");

    ui.addr.textContent=address.slice(0,6)+"..."+address.slice(-4);

    frogs = await fetchPlayableFrogs(address);
    renderFrogList();
    log("Wallet connected.");
  }catch(e){
    console.error(e);
    log(e.message||String(e));
  }
};

ui.startBtn.onclick=startRun;
ui.resetBtn.onclick=resetRun;

ui.mockBtn.onclick=()=>{
  frogs=[
    {tokenId:12,name:"Frog #12",image:"https://freshfrogs.github.io/frog/12.png",rarityTier:"Rare",traits:[{value:"Cyber Eyes"}]},
    {tokenId:666,name:"Frog #666",image:"https://freshfrogs.github.io/frog/666.png",rarityTier:"Epic",traits:[{value:"Ninja Mask"}]},
  ];
  renderFrogList();
};

function renderFrogList(){
  ui.frogList.innerHTML="";
  if(!frogs.length){
    ui.frogList.innerHTML=`<div class="small">No frogs found.</div>`;
    return;
  }
  for(const f of frogs){
    const row=document.createElement("div");
    row.className="frogRow";
    row.innerHTML=`
      <img src="${f.image}"/>
      <div style="flex:1;">
        <div style="font-weight:700;">${f.name}</div>
        <div class="small">${f.rarityTier||"Common"}</div>
      </div>
      <div class="pill">#${f.tokenId}</div>
    `;
    row.onclick=()=>{
      selected=f;
      ui.selectedName.textContent=f.name;
      ui.startBtn.disabled=false;
      resetRun();
      log("Selected frog. Hit Start.");
    };
    ui.frogList.appendChild(row);
  }
}

window.addEventListener("keydown", e=>{
  if(e.code==="Space"||e.code==="ArrowUp"){ e.preventDefault(); jump(); }
});
canvas.addEventListener("pointerdown", jump);
</script>
</body>
</html>
